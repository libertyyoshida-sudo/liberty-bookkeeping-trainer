<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Liberty Bookkeeping Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --primary: #005bac;
      --primary-soft: #e2eef9;
      --accent: #00a0e9;
      --text-main: #222;
      --text-muted: #666;
      --border-soft: #dde3f0;
      --danger: #d9534f;
      --success: #28a745;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
      --radius-xl: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e6f0ff, #f5f7fb 40%, #ffffff 80%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    header .left-block {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    header img.logo {
      height: 40px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--primary);
    }

    header .title-block span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Auth area */
    .auth-box {
      background: var(--bg-card);
      border-radius: 999px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--shadow-soft);
      font-size: 0.75rem;
    }
    .auth-box input {
      font-size: 0.75rem;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      outline: none;
      min-width: 120px;
    }
    .auth-box button {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .auth-small-btn {
      background: #e2e7f3;
    }
    .auth-primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
    }
    .auth-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .auth-box {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-pill {
      font-size: 0.75rem;
      color: var(--bg-card);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      padding: 2px 10px;
      border-radius: 999px;
    }

    .lang-toggle {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      background: var(--primary-soft);
    }

    .lang-toggle button {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .lang-toggle button.active {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(0, 91, 172, 0.06);
    }

    .question-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .badge {
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
    }

    .question-text {
      background: linear-gradient(135deg, #f8fbff, #f3f3ff);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(0, 91, 172, 0.08);
      font-size: 0.9rem;
    }

    .question-text p { margin: 0 0 4px; }
    .question-text p:last-child { margin-bottom: 0; }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }

    .toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .toggle-row input[type="checkbox"] { accent-color: var(--primary); }

    .entry-table {
      margin: 6px 0 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: #fafbff;
    }

    .entry-header-row,
    .entry-row {
      display: grid;
      grid-template-columns: 40px minmax(0, 1.2fr) 100px minmax(0, 1.2fr) 100px;
      gap: 4px;
      align-items: center;
    }

    .entry-header-row {
      background: #e9f1ff;
      padding: 6px 8px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .entry-row {
      padding: 6px 8px;
      font-size: 0.85rem;
      border-top: 1px solid #edf1fb;
      background: #fff;
    }

    .entry-row:nth-child(even) { background: #fdfdff; }

    .entry-row span.row-label {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    select,
    input[type="number"] {
      width: 100%;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      background: #fff;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 91, 172, 0.15);
      background: #f9fcff;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .hint-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 91, 172, 0.35);
    }

    .btn-secondary {
      background: #e2e7f3;
      color: var(--text-main);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(0, 91, 172, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .result-message {
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .result-message.ok { color: var(--success); }
    .result-message.ng { color: var(--danger); }

    .answer-panel {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px dashed rgba(0, 91, 172, 0.25);
      font-size: 0.8rem;
    }

    .answer-panel h3 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .answer-panel pre {
      margin: 0 0 6px;
      background: #fff;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.8rem;
      overflow-x: auto;
    }

    .answer-panel small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .side-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .score-box {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .score-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
    }

    .side-links {
      margin-top: 10px;
      font-size: 0.8rem;
    }
    .side-links a {
      display: inline-block;
      margin-right: 8px;
      text-decoration: none;
      color: var(--primary);
    }

    footer {
      margin-top: 18px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: center;
    }

    /* å‡ºé¡Œè¨­å®šã‚«ãƒ¼ãƒ‰ */
    .settings-card {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #f0f4ff;
      border: 1px solid rgba(0,91,172,0.1);
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
    }
    .settings-card label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .settings-card select,
    .settings-card input[type="number"] {
      font-size: 0.75rem;
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://uczxiifxjzwbarkstvnt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjenhpaWZ4anp3YmFya3N0dm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NTcwODQsImV4cCI6MjA3OTQzMzA4NH0.UCMjF7gaU7HstTPG16QuKi9Idxyl-Zh9AG7XjmvJ1UU";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Supabase ã‹ã‚‰å•é¡Œå–å¾—ï¼†ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // èªè¨¼çŠ¶æ…‹å–å¾—
        const { data: authData } = await supabaseClient.auth.getUser();
        window.sessionUser = authData.user || null;
        if (typeof updateAuthUI === 'function') {
          updateAuthUI();
        }

        // å•é¡Œèª­ã¿è¾¼ã¿
        const { data, error } = await supabaseClient
          .from('quiz_questions')
          .select('*');

        if (error) {
          console.error('Supabase error:', error);
          window.allQuestions = window.hardcodedQuestions;
        } else if (data && data.length > 0) {
          console.log('å–å¾—ã—ãŸã‚¯ã‚¤ã‚ºä»¶æ•°:', data.length);
          window.allQuestions = data;
        } else {
          console.log('Supabase quiz_questions ãŒç©ºã®ãŸã‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å•é¡Œã‚’ä½¿ç”¨ã—ã¾ã™');
          window.allQuestions = window.hardcodedQuestions;
        }

        // å‡ºé¡Œæ¡ä»¶UIã‚’åˆæœŸåŒ–ã—ã¦æœ€åˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        if (typeof setupCategoryFilterOptions === 'function') {
          setupCategoryFilterOptions(window.allQuestions);
        }
        if (typeof startNewSessionFromUI === 'function') {
          startNewSessionFromUI();
        }
      } catch (e) {
        console.error('åˆæœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        window.allQuestions = window.hardcodedQuestions;
        if (typeof startNewSessionFromUI === 'function') {
          startNewSessionFromUI();
        }
      }
    });
  </script>
</head>
<body>
  <div class="page">
    <header>
      <div class="left-block">
        <img src="https://liberty-system.co.jp/common/img/logo.png" alt="Liberty" class="logo" />
        <div class="title-block">
          <h1>Liberty Bookkeeping Trainer</h1>
          <span>ç•™å­¦ç”Ÿãƒ»å®Ÿå‹™å®¶å‘ã‘ ç°¿è¨˜ä»•è¨³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° 2.0</span>
        </div>
      </div>
      <div class="auth-box">
        <div id="auth-when-logged-out">
          <input type="email" id="auth-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
          <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
          <input type="text" id="auth-nationality" placeholder="å›½ç±ï¼ˆä»»æ„ï¼‰" />
          <button class="auth-small-btn" id="btn-signup">æ–°è¦ç™»éŒ²</button>
          <button class="auth-primary-btn" id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        <div id="auth-when-logged-in" style="display:none;">
          <span id="auth-user-label" class="auth-status"></span>
          <button class="auth-small-btn" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </header>

    <!-- å‡ºé¡Œè¨­å®š -->
    <section class="settings-card">
      <label>
        ã‚«ãƒ†ã‚´ãƒª:
        <select id="filter-category">
          <option value="">ã™ã¹ã¦</option>
        </select>
      </label>
      <label>
        å•é¡Œæ•°:
        <input type="number" id="question-count" min="1" max="200" value="10" />
      </label>
      <label>
        <input type="checkbox" id="random-mode-toggle" />
        ãƒ©ãƒ³ãƒ€ãƒ 
      </label>
      <button id="start-session" class="btn btn-secondary" style="padding:4px 10px; font-size:0.75rem;">
        ã“ã®æ¡ä»¶ã§å‡ºé¡Œã™ã‚‹
      </button>
      <span style="color:var(--text-muted);">â€» ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã€å±¥æ­´ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</span>
    </section>

    <div class="layout">
      <!-- å·¦ï¼šå•é¡Œï¼†å…¥åŠ› -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-title-pill">Practice</span>
            <span id="question-label">å•é¡Œ 0 / 0</span>
          </div>
          <div class="lang-toggle">
            <button id="lang-ja" class="active">æ—¥æœ¬èª</button>
            <button id="lang-en">English</button>
          </div>
        </div>

        <div class="question-meta">
          <span class="badge" id="category-label">-</span>
          <span id="id-label">ID: -</span>
          <span id="random-label"></span>
        </div>

        <div class="question-text" id="question-text-ja"></div>
        <div class="question-text" id="question-text-en" style="display:none;"></div>

        <div class="toggle-row">
          <span>å€Ÿæ–¹ãƒ»è²¸æ–¹ã®ç§‘ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>
          <label>
            <input type="checkbox" id="random-mode" />
            ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆæ¬¡ã¸ãƒœã‚¿ãƒ³ç”¨ï¼‰
          </label>
        </div>

        <p class="hint-text">
          è¡Œã”ã¨ã«ã€Œå€Ÿæ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã€Œè²¸æ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
          ä¸è¦ãªæ¬„ã¯ç§‘ç›®ã‚’ã€Œç©ºæ¬„ã€ã®ã¾ã¾ã€é‡‘é¡ã‚‚ç©ºæ¬„ã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
        </p>

        <div class="entry-table">
          <div class="entry-header-row">
            <span>è¡Œ</span>
            <span>å€Ÿæ–¹å‹˜å®šç§‘ç›®</span>
            <span>é‡‘é¡</span>
            <span>è²¸æ–¹å‹˜å®šç§‘ç›®</span>
            <span>é‡‘é¡</span>
          </div>

          <div class="entry-row">
            <span class="row-label">1</span>
            <select class="account-select" id="debit-account-1"></select>
            <input type="number" id="debit-amount-1" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-1"></select>
            <input type="number" id="credit-amount-1" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">2</span>
            <select class="account-select" id="debit-account-2"></select>
            <input type="number" id="debit-amount-2" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-2"></select>
            <input type="number" id="credit-amount-2" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">3</span>
            <select class="account-select" id="debit-account-3"></select>
            <input type="number" id="debit-amount-3" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-3"></select>
            <input type="number" id="credit-amount-3" min="0" inputmode="numeric" />
          </div>
        </div>

        <div class="button-row">
          <button id="prev-question" class="btn btn-secondary">â® å‰ã®å•é¡Œã¸</button>
          <button id="check-answer" class="btn btn-primary">âœ” ç­”ãˆåˆã‚ã›</button>
          <button id="next-question" class="btn btn-outline">â­ æ¬¡ã®å•é¡Œã¸</button>
        </div>

        <div id="result-message" class="result-message"></div>

        <div class="answer-panel" id="answer-panel" style="display:none;">
          <h3>æ¨¡ç¯„ä»•è¨³ / Model Answer</h3>
          <pre id="answer-ja"></pre>
          <pre id="answer-en"></pre>
          <small>â€» ç§‘ç›®åã¨é‡‘é¡ãŒåˆè‡´ã—ã¦ã„ã‚Œã°æ­£è§£ã§ã™ï¼ˆè¡Œã®é †ç•ªã¯å•ã„ã¾ã›ã‚“ï¼‰ã€‚</small>
        </div>
      </section>

      <!-- å³ï¼šé€²æ—ãªã© -->
      <aside class="card">
        <div class="side-card-title">é€²æ— / Progress</div>
        <div class="score-box">
          <div class="score-pill" id="score-pill">æ­£è§£ 0 / 0</div>
        </div>
        <p style="font-size:0.8rem; color:var(--text-muted); margin-top:0;">
          ãƒ»ã€Œç­”ãˆåˆã‚ã›ã€ã§è‡ªå‹•åˆ¤å®šã—ã¾ã™ã€‚<br>
          ãƒ»ä¸Šéƒ¨ã®ã€Œå‡ºé¡Œè¨­å®šã€ã§ã‚«ãƒ†ã‚´ãƒªã‚„å•é¡Œæ•°ã€ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã‚’é¸ã¹ã¾ã™ã€‚<br>
          ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€å›ç­”å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
        <div class="side-links">
          <a href="history.html">ğŸ“Š å­¦ç¿’å±¥æ­´ã‚’è¦‹ã‚‹</a>
          <a href="contents.html">ğŸ“š ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ»å‹•ç”»</a>
          <a href="admin.html">ğŸ›  ç®¡ç†è€…ãƒšãƒ¼ã‚¸</a>
        </div>
      </aside>
    </div>

    <footer>
      &copy; Liberty Co., Ltd. Bookkeeping Trainer 2.0
    </footer>
  </div>

  <script>
    // ---------------------------
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    // ---------------------------
    window.sessionUser = null;
    let allQuestions = [];    // Supabase å…¨å•é¡Œ
    let questions = [];       // ä»Šå›ã®å‡ºé¡Œã‚»ãƒƒãƒˆ
    const hardcodedQuestions = [
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼šæœ€ä½é™ã®å•é¡Œ
      {
        id: "2-1",
        categoryJa: "æ—¥ã€…ã®ä»•è¨³",
        categoryEn: "Daily entries",
        titleJa: "2-1 å£²ä¸Šï¼ˆç¾é‡‘ï¼‹ãƒã‚¤ãƒ³ãƒˆï¼‰",
        titleEn: "2-1 Sales (cash + point)",
        questionJa:
          "å•†å“ã‚’ 1,100å††ã§è²©å£²ã—ã€ãã®ä»£é‡‘ã®ã†ã¡ 100å††ã‚’ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ã€æ®‹ã‚Š 1,000å††ã‚’ç¾é‡‘ã§å—ã‘å–ã£ãŸã€‚100å††ã®ãƒã‚¤ãƒ³ãƒˆã¯ä»–ç¤¾ãŒç™ºè¡Œã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã§å¾Œæ—¥å…¥é‡‘ã•ã‚Œã‚‹ã€‚",
        questionEn:
          "A product was sold for 1,100 yen. 100 yen was paid using points issued by another company (to be received later in cash), and the remaining 1,000 yen was received in cash.",
        solution: {
          debit: [
            { account: "å£²æ›é‡‘", amount: 100 },
            { account: "ç¾é‡‘", amount: 1000 }
          ],
          credit: [
            { account: "å£²ä¸Š", amount: 1100 }
          ]
        },
        journalJa: "å€Ÿæ–¹ï¼šå£²æ›é‡‘ 100ã€€ç¾é‡‘ 1,000ã€€/ã€€è²¸æ–¹ï¼šå£²ä¸Š 1,100",
        journalEn: "Debit: Accounts Receivable 100, Cash 1,000 / Credit: Sales 1,100"
      }
    ];

    const accountMaster = [
      "",
      "ç¾é‡‘",
      "æ™®é€šé é‡‘",
      "å£²æ›é‡‘",
      "è²·æ›é‡‘",
      "æœªæ‰•é‡‘",
      "ä»•å…¥",
      "å£²ä¸Š",
      "æ¶ˆè€—å“è²»"
    ];

    let currentIndex = 0;
    let currentLang = "ja";
    let randomMode = false;
    let historyStack = [];
    let totalAnswered = 0;
    let totalCorrect = 0;

    // DOM å–å¾—
    const questionLabel = document.getElementById("question-label");
    const categoryLabel = document.getElementById("category-label");
    const idLabel = document.getElementById("id-label");
    const randomLabel = document.getElementById("random-label");
    const questionTextJa = document.getElementById("question-text-ja");
    const questionTextEn = document.getElementById("question-text-en");
    const langJaBtn = document.getElementById("lang-ja");
    const langEnBtn = document.getElementById("lang-en");
    const randomModeCheckbox = document.getElementById("random-mode");
    const prevBtn = document.getElementById("prev-question");
    const nextBtn = document.getElementById("next-question");
    const checkBtn = document.getElementById("check-answer");
    const resultMessage = document.getElementById("result-message");
    const answerPanel = document.getElementById("answer-panel");
    const answerJa = document.getElementById("answer-ja");
    const answerEn = document.getElementById("answer-en");
    const scorePill = document.getElementById("score-pill");

    const filterCategorySelect = document.getElementById("filter-category");
    const questionCountInput = document.getElementById("question-count");
    const randomModeToggle = document.getElementById("random-mode-toggle");
    const startSessionBtn = document.getElementById("start-session");

    // Auth UI
    const authLoggedOut = document.getElementById('auth-when-logged-out');
    const authLoggedIn = document.getElementById('auth-when-logged-in');
    const authUserLabel = document.getElementById('auth-user-label');
    const emailInput = document.getElementById('auth-email');
    const passwordInput = document.getElementById('auth-password');
    const nationalityInput = document.getElementById('auth-nationality');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');

    // ---------------------------
    // Auth é–¢é€£
    // ---------------------------
    function updateAuthUI() {
      if (window.sessionUser) {
        authLoggedOut.style.display = 'none';
        authLoggedIn.style.display = 'flex';
        authUserLabel.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${window.sessionUser.email}`;
      } else {
        authLoggedOut.style.display = 'flex';
        authLoggedIn.style.display = 'none';
      }
    }

    async function signUp() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      const nationality = nationalityInput.value.trim();
      if (!email || !password) {
        alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { nationality }
        }
      });
      if (error) {
        console.error('signUp error', error);
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return;
      }
      const user = data.user;
      if (user) {
        // profiles ã«ã‚‚ä½œæˆ
        await supabaseClient.from('profiles').insert({
          id: user.id,
          email: user.email,
          nationality,
          role: 'user'
        }).catch(e => console.error('profiles insert error', e));
      }
      alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒå±Šã„ã¦ã„ã‚‹å ´åˆã¯ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    async function signIn() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });
      if (error) {
        console.error('signIn error', error);
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return;
      }
      window.sessionUser = data.user;
      updateAuthUI();
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.sessionUser = null;
      updateAuthUI();
      alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
    }

    btnSignup.addEventListener('click', signUp);
    btnLogin.addEventListener('click', signIn);
    btnLogout.addEventListener('click', signOut);

    // ---------------------------
    // å‡ºé¡Œã‚»ãƒƒãƒˆä½œæˆ
    // ---------------------------
    function setupCategoryFilterOptions(all) {
      // categoryJa ãŒã‚ã‚‹ã‚‚ã®ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«
      const cats = Array.from(
        new Set(
          all
            .map(q => q.categoryJa)
            .filter(x => typeof x === 'string' && x.length > 0)
        )
      ).sort();
      filterCategorySelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        filterCategorySelect.appendChild(opt);
      });
    }

    function createQuestionSetFromUI() {
      let list = allQuestions || [];
      const selCat = filterCategorySelect.value;
      const count = Number(questionCountInput.value || '10');
      const randomFlag = randomModeToggle.checked;

      if (selCat) {
        list = list.filter(q => q.categoryJa === selCat);
      }

      if (randomFlag) {
        list = [...list].sort(() => Math.random() - 0.5);
      } else {
        list = [...list];
      }

      questions = list.slice(0, Math.max(1, count));
      currentIndex = 0;
      historyStack = [];
      totalAnswered = 0;
      totalCorrect = 0;
      randomMode = randomModeCheckbox.checked;
      updateScore();
    }

    function startNewSessionFromUI() {
      createQuestionSetFromUI();
      initAccountSelects();
      renderQuestion();
    }

    startSessionBtn.addEventListener('click', () => {
      startNewSessionFromUI();
    });

    // ---------------------------
    // å‹˜å®šç§‘ç›®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
    // ---------------------------
    function initAccountSelects() {
      const selects = document.querySelectorAll(".account-select");
      selects.forEach((sel) => {
        sel.innerHTML = "";
        accountMaster.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name === "" ? "ï¼ˆç©ºæ¬„ï¼‰" : name;
          sel.appendChild(opt);
        });
      });
    }

    function clearEntryInputs() {
      for (let i = 1; i <= 3; i++) {
        document.getElementById("debit-account-" + i).value = "";
        document.getElementById("debit-amount-" + i).value = "";
        document.getElementById("credit-account-" + i).value = "";
        document.getElementById("credit-amount-" + i).value = "";
      }
      resultMessage.textContent = "";
      resultMessage.className = "result-message";
      answerPanel.style.display = "none";
    }

    function renderQuestion() {
      if (!questions || questions.length === 0) {
        questionLabel.textContent = "å•é¡Œ 0 / 0";
        categoryLabel.textContent = "-";
        idLabel.textContent = "ID: -";
        questionTextJa.textContent = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        questionTextEn.textContent = "No questions.";
        return;
      }
      const q = questions[currentIndex];
      questionLabel.textContent = `å•é¡Œ ${currentIndex + 1} / ${questions.length}`;
      categoryLabel.textContent = currentLang === "ja" ? (q.categoryJa || "-") : (q.categoryEn || "-");
      idLabel.textContent = `ID: ${q.id}`;
      const sourceLabel = (allQuestions === hardcodedQuestions) ? "ï¼»ãƒ­ãƒ¼ã‚«ãƒ«å•é¡Œï¼½" : "ï¼»DBã‹ã‚‰èª­è¾¼ï¼½";
      randomLabel.textContent = sourceLabel + (randomMode ? "ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œä¸­ï¼‰" : "");

      questionTextJa.textContent = q.questionJa || "";
      questionTextEn.textContent = q.questionEn || "";

      if (currentLang === "ja") {
        questionTextJa.style.display = "block";
        questionTextEn.style.display = "none";
      } else {
        questionTextJa.style.display = "none";
        questionTextEn.style.display = "block";
      }

      langJaBtn.classList.toggle("active", currentLang === "ja");
      langEnBtn.classList.toggle("active", currentLang === "en");
      randomModeCheckbox.checked = randomMode;

      clearEntryInputs();
    }

    function updateScore() {
      scorePill.textContent = `æ­£è§£ ${totalCorrect} / ${totalAnswered}`;
    }

    function goNextQuestion() {
      historyStack.push(currentIndex);
      if (randomMode) {
        let next;
        if (questions.length === 1) {
          next = 0;
        } else {
          do {
            next = Math.floor(Math.random() * questions.length);
          } while (next === currentIndex);
        }
        currentIndex = next;
      } else {
        currentIndex = (currentIndex + 1) % questions.length;
      }
      renderQuestion();
    }

    function goPrevQuestion() {
      if (historyStack.length === 0) return;
      const prevIndex = historyStack.pop();
      currentIndex = prevIndex;
      renderQuestion();
    }

    function getUserEntries() {
      const debit = [];
      const credit = [];
      for (let i = 1; i <= 3; i++) {
        const dAcc = document.getElementById("debit-account-" + i).value.trim();
        const dAmtStr = document.getElementById("debit-amount-" + i).value.trim();
        const cAcc = document.getElementById("credit-account-" + i).value.trim();
        const cAmtStr = document.getElementById("credit-amount-" + i).value.trim();

        if (dAcc !== "" && dAmtStr !== "") {
          const amt = Number(dAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            debit.push({ account: dAcc, amount: amt });
          }
        }
        if (cAcc !== "" && cAmtStr !== "") {
          const amt = Number(cAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            credit.push({ account: cAcc, amount: amt });
          }
        }
      }
      return { debit, credit };
    }

    function isBalanced(entries) {
      const sum = (list) => list.reduce((acc, e) => acc + e.amount, 0);
      return sum(entries.debit) === sum(entries.credit);
    }

    function compareSide(userList, correctList) {
      if (!Array.isArray(correctList)) return false;
      if (userList.length !== correctList.length) return false;

      const remaining = correctList.map((e) => ({ ...e }));
      for (const u of userList) {
        const index = remaining.findIndex(
          (c) => c.account === u.account && Number(c.amount) === Number(u.amount)
        );
        if (index === -1) return false;
        remaining.splice(index, 1);
      }
      return remaining.length === 0;
    }

    async function saveQuizLog(q, userEntries, isCorrect) {
      const { data: authData } = await supabaseClient.auth.getUser();
      const user = authData.user;
      if (!user) {
        return; // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ä¿å­˜ã—ãªã„
      }
      const payload = {
        user_id: user.id,
        content_type: 'quiz',
        content_id: q.id,
        action: 'answer',
        is_correct: isCorrect,
        answer_json: userEntries,
        created_at: new Date().toISOString()
      };
      const { error } = await supabaseClient.from('study_logs').insert(payload);
      if (error) {
        console.error('study_logs insert error', error);
      }
    }

    async function checkAnswer() {
      if (!questions || questions.length === 0) return;
      const q = questions[currentIndex];
      const user = getUserEntries();

      if (user.debit.length === 0 && user.credit.length === 0) {
        resultMessage.textContent = "ç§‘ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      if (!isBalanced(user)) {
        resultMessage.textContent = "å€Ÿæ–¹åˆè¨ˆã¨è²¸æ–¹åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      const solution = q.solution || { debit: [], credit: [] };
      const okDebit = compareSide(user.debit, solution.debit || []);
      const okCredit = compareSide(user.credit, solution.credit || []);
      const isCorrect = okDebit && okCredit;

      totalAnswered++;
      if (isCorrect) totalCorrect++;
      updateScore();

      if (isCorrect) {
        resultMessage.textContent = "â— æ­£è§£ã§ã™ï¼ ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã€‚";
        resultMessage.className = "result-message ok";
      } else {
        resultMessage.textContent = "Ã— æƒœã—ã„ã§ã™ã€‚æ¨¡ç¯„ä»•è¨³ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        resultMessage.className = "result-message ng";
      }

      answerJa.textContent = q.journalJa || "";
      answerEn.textContent = q.journalEn || "";
      answerPanel.style.display = "block";

      // å±¥æ­´ä¿å­˜
      await saveQuizLog(q, user, isCorrect);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    langJaBtn.addEventListener("click", () => {
      currentLang = "ja";
      renderQuestion();
    });
    langEnBtn.addEventListener("click", () => {
      currentLang = "en";
      renderQuestion();
    });
    randomModeCheckbox.addEventListener("change", (e) => {
      randomMode = e.target.checked;
      renderQuestion();
    });
    nextBtn.addEventListener("click", goNextQuestion);
    prevBtn.addEventListener("click", goPrevQuestion);
    checkBtn.addEventListener("click", checkAnswer);
  </script>
</body>
</html>


