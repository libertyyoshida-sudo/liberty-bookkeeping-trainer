<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Liberty Bookkeeping Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --primary: #005bac;
      --primary-soft: #e2eef9;
      --accent: #00a0e9;
      --text-main: #222;
      --text-muted: #666;
      --border-soft: #dde3f0;
      --danger: #d9534f;
      --success: #28a745;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e6f0ff, #f5f7fb 40%, #ffffff 80%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    header img.logo {
      height: 40px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 220px;
    }

    header .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--primary);
    }

    header .title-block span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .auth-box {
      background: #fff;
      border-radius: 16px; /* 999px だと縦長ボックスがちょっと変なので少し小さめに */
      padding: 8px 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;        /* ★縦並びに変更 */
      align-items: stretch;          /* ★中身を幅いっぱいに */
      gap: 6px;
      font-size: 0.75rem;
       max-width: 320px;              /* ★スマホでのはみ出し防止 */
    }

    /* メールアドレス・パスワードを縦に並べる */
    .auth-fields {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* ログインボタン＆リンクたち */
   .auth-actions {
     display: flex;
     flex-direction: column;
     gap: 4px;
    } 
    
   /* auth-box内の入力・ボタンは幅100%に */
   .auth-box input,
   .auth-box button {
     width: 100%;
     box-sizing: border-box;
    }

   /* 新規登録/パスワードリセットのリンク */
   .auth-link {
     display: block;
     width: 100%;
     text-align: left;
     font-size: 0.75rem;
     color: var(--primary);
     text-decoration: none;
   }

   .auth-link:hover {
     text-decoration: underline;
   }

    .auth-box input {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 8px;
      font-size: 0.75rem;
      min-width: 130px;
    }

    .auth-primary-btn,
    .auth-small-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 4px 10px;
      white-space: nowrap;
    }

    .auth-primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
    }

    .auth-small-btn {
      background: #e2e7f3;
      color: var(--text-main);
    }

    .auth-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* 上部ナビボタン */
    .top-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }

    .top-nav a {
      text-decoration: none;
    }

    .top-nav-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: #ffffff;
      color: var(--primary);
      border: 1px solid rgba(0, 91, 172, 0.25);
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .top-nav-btn span.icon {
      font-size: 0.9rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .auth-box {
        width: 100%;
        justify-content: flex-start;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-pill {
      font-size: 0.75rem;
      color: var(--bg-card);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      padding: 2px 10px;
      border-radius: 999px;
    }

    .lang-toggle {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      background: var(--primary-soft);
    }

    .lang-toggle button {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .lang-toggle button.active {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(0, 91, 172, 0.06);
    }

    .question-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .badge {
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
    }

    .question-text {
      background: linear-gradient(135deg, #f8fbff, #f3f3ff);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(0, 91, 172, 0.08);
      font-size: 0.9rem;
    }

    .question-text p {
      margin: 0 0 4px;
    }

    .question-text p:last-child {
      margin-bottom: 0;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }

    .toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .toggle-row input[type="checkbox"] {
      accent-color: var(--primary);
    }

    /* 出題条件 */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      align-items: center;
    }

    .filter-row select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font-size: 0.8rem;
    }

    .filter-row button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e2e7f3;
      color: var(--text-main);
      white-space: nowrap;
    }

    /* 仕訳入力テーブル */
    .entry-table {
      margin: 6px 0 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: #fafbff;
    }

    .entry-header-row,
    .entry-row {
      display: grid;
      grid-template-columns: 40px minmax(0, 1.2fr) 100px minmax(0, 1.2fr) 100px;
      gap: 4px;
      align-items: center;
    }

    .entry-header-row {
      background: #e9f1ff;
      padding: 6px 8px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .entry-row {
      padding: 6px 8px;
      font-size: 0.85rem;
      border-top: 1px solid #edf1fb;
      background: #fff;
    }

    .entry-row:nth-child(even) {
      background: #fdfdff;
    }

    .entry-row span.row-label {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    select,
    input[type="number"] {
      width: 100%;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      background: #fff;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 91, 172, 0.15);
      background: #f9fcff;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .hint-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 91, 172, 0.35);
    }

    .btn-secondary {
      background: #e2e7f3;
      color: var(--text-main);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(0, 91, 172, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .result-message {
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .result-message.ok {
      color: var(--success);
    }

    .result-message.ng {
      color: var(--danger);
    }

    .answer-panel {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px dashed rgba(0, 91, 172, 0.25);
      font-size: 0.8rem;
    }

    .answer-panel h3 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .answer-panel pre {
      margin: 0 0 6px;
      background: #fff;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.8rem;
      overflow-x: auto;
    }

    .answer-panel small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .side-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .score-box {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .score-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
    }

    .history-box-title {
      margin-top: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .history-list {
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      background: #f9fbff;
      font-size: 0.75rem;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 3px 0;
      border-bottom: 1px dashed #e1e5f0;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item span.correct {
      color: var(--success);
      font-weight: 600;
    }

    .history-item span.wrong {
      color: var(--danger);
      font-weight: 600;
    }

    footer {
      margin-top: 18px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: center;
    }

    ruby {
      ruby-position: over;   /* 横書きで上に表示する指定 */
      -webkit-ruby-position: before; /* for older Chrome */
    }

    rt {
      font-size: 0.6em;      /* ルビを小さめに */
      line-height: 1;
      text-align: center;
    }
    
  </style>
  
  <script src="https://unpkg.com/kuromoji@0.1.2/dist/kuromoji.min.js"></script>
  <script src="https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
  <script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
 
  <!-- ⭐ Supabase を「外で」読み込む（ここがポイント） -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    const SUPABASE_URL = "https://uczxiifxjzwbarkstvnt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjenhpaWZ4anp3YmFya3N0dm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NTcwODQsImV4cCI6MjA3OTQzMzA4NH0.UCMjF7gaU7HstTPG16QuKi9Idxyl-Zh9AG7XjmvJ1UU";

    // CDN版 supabase-js v2 は window.supabase にぶら下がる
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
// 画面文言の多言語対応
const i18n = {
  ja: {
    'app-title': 'Liberty Bookkeeping Trainer',
    'app-subtitle': '留学生・実務家向け 簿記仕訳トレーニング 2.0',
    'practice-pill': 'Practice',
    'question-label-prefix': '問題',       // 「問題 1 / 10」の「問題」部分
    'filter-category': 'カテゴリ:',
    'filter-count': '問題数:',
    'filter-start': '出題開始',
    'toggle-main': '借方・貸方の科目と金額を入力してください。',
    'toggle-random': 'ランダム出題',
    'hint-text':
      '行ごとに「借方勘定科目・金額」「貸方勘定科目・金額」を入力します。\n不要な欄は科目を「空欄」のまま、金額も空欄にしておいてください。',
    'entry-col-row': '行',
    'entry-col-debit': '借方勘定科目',
    'entry-col-debit-amount': '金額',
    'entry-col-credit': '貸方勘定科目',
    'entry-col-credit-amount': '金額',
    'btn-prev': '⏮ 前の問題へ',
    'btn-check': '✔ 答え合わせ',
    'btn-next': '⏭ 次の問題へ',
    'answer-title': '模範仕訳 / Model Answer',
    'answer-note': '※ 科目名と金額が合致していれば正解です（行の順番は問いません）。',
    'progress-title': '進捗 / Progress',
    'history-title': '直近の学習履歴',
    'history-not-logged-in': 'ログインすると直近の解答履歴が表示されます。',
    'history-none': 'まだ履歴がありません。',
    'footer': '© Liberty Co., Ltd. Bookkeeping Trainer 2.0',
    'progress-title': '進捗 / Progress',
    'progress-help':
      '・「出題開始」で選択した条件の問題セットを開始します。\n' +
      '・「答え合わせ」で自動判定します。\n' +
      '・ランダム出題をONにすると、順番をシャッフルします。\n' +
      '・日本語 / 英語はいつでも切り替え可能です。',
    'history-title': '直近の学習履歴',

    // メッセージ系
    'msg-input-required': '科目と金額を入力してください。',
    'msg-not-balanced': '借方合計と貸方合計が一致していません。もう一度確認してください。',
    'msg-correct': '◎ 正解です！ とても良いです。',
    'msg-wrong': '× 惜しいです。模範仕訳を確認してみましょう。',
    'score': (correct, total) => `正解 ${correct} / ${total}`
  },
  en: {
    'app-title': 'Liberty Bookkeeping Trainer',
    'app-subtitle': 'Bookkeeping Journal Entry Trainer for International Students & Practitioners',
    'practice-pill': 'Practice',
    'question-label-prefix': 'Question',
    'filter-category': 'Category:',
    'filter-count': 'Number of questions:',
    'filter-start': 'Start',
    'toggle-main': 'Enter the accounts and amounts for debit and credit.',
    'toggle-random': 'Random order',
    'hint-text':
      'For each row, enter “debit account / amount” and “credit account / amount”.\nIf a row is not needed, leave both the account and amount blank.',
    'entry-col-row': 'Row',
    'entry-col-debit': 'Debit account',
    'entry-col-debit-amount': 'Amount',
    'entry-col-credit': 'Credit account',
    'entry-col-credit-amount': 'Amount',
    'btn-prev': '⏮ Previous',
    'btn-check': '✔ Check answer',
    'btn-next': '⏭ Next',
    'answer-title': 'Model Answer',
    'answer-note': 'If both account names and amounts match, it is correct (row order does not matter).',
    'progress-title': 'Progress',
    'history-title': 'Recent study history',
    'history-not-logged-in': 'Log in to see your recent answer history.',
    'history-none': 'No history yet.',
    'footer': '© Liberty Co., Ltd. Bookkeeping Trainer 2.0',
    'progress-title': 'Progress',
    'progress-help':
      '・Click "Start" to begin questions with the selected conditions.\n' +
      '・Click "Check answer" to auto-grade your entry.\n' +
      '・Turn on "Random order" to shuffle questions.\n' +
      '・You can switch between Japanese / English at any time.',
    'history-title': 'Recent study history',

    'msg-input-required': 'Please enter both account names and amounts.',
    'msg-not-balanced': 'Debit total and credit total do not match. Please check again.',
    'msg-correct': '◎ Correct! Well done.',
    'msg-wrong': '× Almost. Check the model journal entry.',
    'score': (correct, total) => `Correct ${correct} / ${total}`
  }
};
    
    // ---------------------------
    // グローバル状態
    // ---------------------------
    window.sessionUser = null;

    // Supabase から取得する全問題
    let allQuestions = [];

    // 仕訳入力の行数（将来 5 行、6 行にしたければここを変える）
    const ENTRY_ROW_COUNT = 4;   // 今は 4 行にしたい

    // 今回の出題セット
    let questions = [];

    // フォールバック用のハードコード問題
    const hardcodedQuestions = [
      {
        id: "2-1",
        categoryJa: "日々の仕訳",
        categoryEn: "Daily entries",
        titleJa: "2-1 売上（現金＋ポイント）",
        titleEn: "2-1 Sales (cash + point)",
        questionJa:
          "商品を 1,100円で販売し、その代金のうち 100円をポイント利用、残り 1,000円を現金で受け取った。100円のポイントは他社が発行するポイントで後日入金される。",
        questionEn:
          "A product was sold for 1,100 yen. 100 yen was paid using points issued by another company (to be received later in cash), and the remaining 1,000 yen was received in cash.",
        solution: {
          debit: [
            { account: "売掛金", amount: 100 },
            { account: "現金", amount: 1000 }
          ],
          credit: [
            { account: "売上", amount: 1100 }
          ]
        },
        journalJa: "借方：売掛金 100　現金 1,000　/　貸方：売上 1,100",
        journalEn: "Debit: Accounts Receivable 100, Cash 1,000 / Credit: Sales 1,100",
        account_options: "現金,売掛金,売上"
      }
      // …必要なら他のハードコード問題にも account_options を追加
    ];

    // デフォルトの勘定科目マスター（account_options 未設定の問題用）
    const accountMaster = [
      "",
      "現金",
      "普通預金",
      "売掛金",
      "買掛金",
      "未払金",
      "仕入",
      "売上",
      "消耗品費"
    ];

        // ★ カテゴリの表示順をここで定義（グローバル）
    const CATEGORY_ORDER = [
      "日々の仕訳",
      "月次の仕訳",
      "定期仕訳",
      "決算仕訳",
      "その他"
    ];

    // 状態
let currentIndex = 0;
let currentLang = "ja";
let randomMode = false;
let historyStack = []; // 戻る用にインデックスを積む
let totalAnswered = 0;
let totalCorrect = 0;

// ルビ表示用
let rubyEnabled = false;
let kuroshiro = null;
let kuroshiroReady = false;
let kuroshiroInitPromise = null;    

function initKuroshiro() {
  // すでに初期化済みならそのまま返す
  if (kuroshiroReady && kuroshiro) {
    return Promise.resolve();
  }

   // ✅ 初期化中なら、そのPromiseを返す（2回目以降はここ）
  if (kuroshiroInitPromise) {
    return kuroshiroInitPromise;
  }

   // ✅ 初期化処理をPromiseとして保持
   kuroshiroInitPromise = new Promise(async (resolve, reject) => {
    try {
      const KuroClass = window.Kuroshiro?.default || window.Kuroshiro;
      kuroshiro = new KuroClass();

  const dictPath = "./dict/";
      const AnalyzerClass =
        window.KuromojiAnalyzer ||
        window.KuroshiroAnalyzerKuromoji;

      if (!AnalyzerClass) {
        throw new Error("KuromojiAnalyzer が読み込まれていません");
      }

      const analyzer = new AnalyzerClass({ dictPath });

      await kuroshiro.init(analyzer);

      kuroshiroReady = true;
      console.log("Kuroshiro initialized ✅");
      resolve(true);

    } catch (e) {
      console.error("Kuroshiro init error:", e);

      // ✅ 失敗したら Promise をリセットして再挑戦できるようにする
      kuroshiroInitPromise = null;
      reject(e);
    }
  });

  return kuroshiroInitPromise;
}    
      
  return new Promise(async (resolve, reject) => {
    // グローバルに読み込まれているか確認
    if (typeof Kuroshiro === "undefined") {
      console.error("Kuroshiro が見つかりません。");
      alert("ルビ用ライブラリ(Kuroshiro)の読み込みに失敗しました。");
      reject(new Error("Kuroshiro not loaded"));
      return;
    }
    if (typeof KuromojiAnalyzer === "undefined") {
      console.error("KuromojiAnalyzer が見つかりません。");
      alert("ルビ用アナライザ(KuromojiAnalyzer)の読み込みに失敗しました。");
      reject(new Error("KuromojiAnalyzer not loaded"));
      return;
    }

    try {
  // ★修正①：Kuroshiro を default 対応で生成
  const KuroClass = window.Kuroshiro?.default || window.Kuroshiro;
  kuroshiro = new KuroClass();

  // ★修正②：dictPath を自分の Pages の dict にする
  const dictPath = "https://libertyyoshida-sudo.github.io/liberty-bookkeeping-trainer/dict";
  console.log("dictPath =", dictPath);

  const AnalyzerClass =
    window.KuromojiAnalyzer ||
    window.KuroshiroAnalyzerKuromoji ||

  if (!AnalyzerClass) {
  throw new Error("KuromojiAnalyzer が読み込まれていません");  
    
  const analyzer = new KuromojiAnalyzer({ dictPath });

  kuroshiro
    .init(analyzer)
    .then(() => {
      kuroshiroReady = true;
      console.log("Kuroshiro initialized ✅ dictPath =", dictPath);
      resolve(true);
    })
    .catch((e) => {
      console.error("Kuroshiro init error:", e);
      alert("ルビ初期化でエラーが発生しました: " + (e?.message || e));
      reject(e);
    });
} catch (e) {
  console.error("Kuroshiro init 中に例外:", e);
  alert("ルビ初期化でエラーが発生しました: " + (e?.message || e));
  reject(e);
}
  });
}

// Kuroshiro の furigana 出力「漢(かん)字」を <ruby>漢<rt>かん</rt>字</ruby> に変換
function furiganaTextToRubyHtml(str) {
  // 例: 商品(しょうひん)を → <ruby>商品<rt>しょうひん</rt></ruby>を
  return str.replace(
    /([一-龠々〆ヵヶ]+)\(([^)]+)\)/g,
    "<ruby>$1<rt>$2</rt></ruby>"
  );
}

    // DOM 取得（後で埋まるので let で宣言だけしておく）
    let questionLabel, categoryLabel, idLabel, randomLabel;
    let questionTextJa, questionTextEn;
    let langJaBtn, langEnBtn, randomModeCheckbox;
    let prevBtn, nextBtn, checkBtn;
    let resultMessage, answerPanel, answerJa, answerEn, scorePill;
    let categoryFilterSelect, questionCountSelect, historyListEl;

    // ---------------------------
    // 認証まわり
    // ---------------------------
    function updateAuthUI() {
      const authLoggedOut = document.getElementById('auth-when-logged-out');
      const authLoggedIn = document.getElementById('auth-when-logged-in');
      const authUserLabel = document.getElementById('auth-user-label');

      if (!authLoggedOut || !authLoggedIn || !authUserLabel) return;

      if (window.sessionUser) {
        authLoggedOut.style.display = 'none';
        authLoggedIn.style.display = 'flex';
        authUserLabel.textContent = `ログイン中: ${window.sessionUser.email || ''}`;
      } else {
        authLoggedOut.style.display = 'flex';
        authLoggedIn.style.display = 'none';
        authUserLabel.textContent = '';
      }
    }

    async function signIn() {
      const emailInput = document.getElementById('auth-email');
      const passwordInput = document.getElementById('auth-password');
      if (!emailInput || !passwordInput) return;

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        alert('メールアドレスとパスワードを入力してください。');
        return;
      }

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        console.error('signIn error', error);
        alert('ログインに失敗しました: ' + error.message);
        return;
      }

      window.sessionUser = data.user;
      updateAuthUI();
      loadMyHistory();
      alert('ログインしました。');
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.sessionUser = null;
      updateAuthUI();
      loadMyHistory();
      alert('ログアウトしました。');
    }

    // ---------------------------
    // 勘定科目プルダウン関連
    // ---------------------------

    // 問題レコードから「この問題で使える勘定科目リスト」を生成
    function buildAccountListFromQuestion(q) {
      let list = [];

      if (q && q.account_options) {
        if (Array.isArray(q.account_options)) {
          // account_options が JSON 配列の場合
          list = q.account_options;
        } else if (typeof q.account_options === 'string') {
          // カンマ区切り文字列の場合
          list = q.account_options
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
        }
      }

      // account_options が空ならデフォルトマスターを使用
      if (!list || list.length === 0) {
        list = accountMaster.slice(1); // 空欄以外をベースに
      }

      // 重複除去
      const unique = Array.from(new Set(list));

      // 先頭に「空欄」を追加
      unique.unshift("");

      return unique;
    }

    // 渡された勘定科目リストで、全てのセレクトボックスを再構築
    function setAccountSelectOptions(accountList) {
      const selects = document.querySelectorAll(".account-select");
      selects.forEach((sel) => {
        const currentValue = sel.value; // 一応退避

        sel.innerHTML = "";
        accountList.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name === "" ? "（空欄）" : name;
          sel.appendChild(opt);
        });

        // もし元の値がまだリストに存在するなら、復元してもよい
        if (accountList.includes(currentValue)) {
          sel.value = currentValue;
        }
      });
    }

    // 初期化用（最初に何も問題がない状態で呼ぶ）
    function initAccountSelects() {
      setAccountSelectOptions(accountMaster);
    }

    // 入力をクリア
    function clearEntryInputs() {
      for (let i = 1; i <= ENTRY_ROW_COUNT; i++) {
        document.getElementById("debit-account-" + i).value = "";
        document.getElementById("debit-amount-" + i).value = "";
        document.getElementById("credit-account-" + i).value = "";
        document.getElementById("credit-amount-" + i).value = "";
      }
      resultMessage.textContent = "";
      resultMessage.className = "result-message";
      answerPanel.style.display = "none";
    }

    // スコア表示更新
    function updateScore() {
      if (!scorePill) return;
      scorePill.textContent = `正解 ${totalCorrect} / ${totalAnswered}`;
    }

    // 出題カテゴリ・問題数の選択肢をセット
    function setupCategoryFilterOptions(all) {
      if (!categoryFilterSelect || !questionCountSelect) return;

    // まずカテゴリ一覧を重複なしで収集
    const catsSet = new Set();
      all.forEach(q => {
        if (q.categoryJa) catsSet.add(q.categoryJa);
      });

  // ★ 自分で決めた順番でソート
    const cats = [...catsSet].sort((a, b) => {
      const ia = CATEGORY_ORDER.indexOf(a);
      const ib = CATEGORY_ORDER.indexOf(b);

    // CATEGORY_ORDER に載ってないものは後ろに回す
    if (ia === -1 && ib === -1) {
      // 両方とも未定義なら一応五十音で
      return a.localeCompare(b, "ja");
    }
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  // セレクト生成
  categoryFilterSelect.innerHTML = '';
  const optAll = document.createElement('option');
  optAll.value = '';
  optAll.textContent = 'すべてのカテゴリ';
  categoryFilterSelect.appendChild(optAll);

  cats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    categoryFilterSelect.appendChild(opt);
  });

   // 問題数
      questionCountSelect.innerHTML = '';
      [5, 10, 20, 50].forEach(n => {
        const opt = document.createElement('option');
        opt.value = String(n);
        opt.textContent = `最大 ${n}問`;
        questionCountSelect.appendChild(opt);
      });
      const optAllQ = document.createElement('option');
      optAllQ.value = 'all';
      optAllQ.textContent = '全件';
      questionCountSelect.appendChild(optAllQ);

      // デフォルト
      questionCountSelect.value = '10';
    }

    // 配列をシャッフル
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // 出題セット作成
    function createQuestionSetFromUI() {
      if (!allQuestions || allQuestions.length === 0) {
        questions = [];
        return;
      }
      const cat = categoryFilterSelect ? categoryFilterSelect.value : '';
      const countValue = questionCountSelect ? questionCountSelect.value : '10';

      let pool = allQuestions;
      if (cat) {
        pool = pool.filter(q => q.categoryJa === cat);
      }

      if (pool.length === 0) {
        questions = [];
        return;
      }

      shuffleArray(pool);
      let maxCount = pool.length;
      if (countValue !== 'all') {
        const n = Number(countValue);
        if (!Number.isNaN(n)) {
          maxCount = Math.min(n, pool.length);
        }
      }
      questions = pool.slice(0, maxCount);
      currentIndex = 0;
      historyStack = [];
    }

    // 新しいセッション開始（UI操作から）
    function startNewSessionFromUI() {
      createQuestionSetFromUI();
      if (!questions || questions.length === 0) {
        questionLabel.textContent = '問題がありません。';
        questionTextJa.textContent = '';
        questionTextEn.textContent = '';
        categoryLabel.textContent = '';
        idLabel.textContent = '';
        randomLabel.textContent = '';
        initAccountSelects();
        clearEntryInputs();
        return;
      }
      totalAnswered = 0;
      totalCorrect = 0;
      updateScore();
      renderQuestion();
    }
    
//言語適用関数 applyLanguage を作る
function applyLanguage() {
  const t = i18n[currentLang];

  // data-i18n 付き要素の共通処理
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.dataset.i18n;
    const value = t[key];
    if (!value) return;

    // 改行を <br> にしたい要素もあるので少し分岐
    if (el.id === 'hint-text' || el.id === 'progress-help') {
      el.innerHTML = value.replace(/\n/g, '<br>');
    } else {
      el.textContent = value;
    }
  });

  // スコア表示
  if (scorePill) {
    scorePill.textContent = t.score(totalCorrect, totalAnswered);
  }

  // 履歴エリア（ログインしていないときのメッセージなど）は loadMyHistory 内で t を使う形でもOK
}
    
// 画面へ問題を反映 - 修正後
function renderQuestion() {
  if (!questions || questions.length === 0) {
    questionLabel.textContent = '問題がありません。';
    return;
  }
  
  const q = questions[currentIndex];
  questionLabel.textContent = `問題 ${currentIndex + 1} / ${questions.length}`;
  categoryLabel.textContent = currentLang === "ja" ? (q.categoryJa || '') : (q.categoryEn || '');
  idLabel.textContent = `ID: ${q.id || ''}`;
  randomLabel.textContent = randomMode ? "（ランダム出題中）" : "";

  if (currentLang === "ja") {
    questionTextEn.style.display = "none";
    questionTextJa.style.display = "block";

    const text = q.questionJa || "";

    // ルビONかつ Kuroshiro 初期化済みなら <ruby> に変換
    if (rubyEnabled && kuroshiroReady && kuroshiro) {
      // まず一時的にテキストを表示
      questionTextJa.textContent = text;
      
      // 非同期でルビ変換を適用
      kuroshiro.convert(text, {
        to: "hiragana",
        mode: "furigana"
     }).then((furiganaText) => {
      console.log("変換結果(raw):", furiganaText);
        
        // まだ同じ問題を表示しているか確認
      if (questions[currentIndex] === q) {
        const rubyHtml = furiganaTextToRubyHtml(furiganaText);
        questionTextJa.innerHTML = rubyHtml;
      }
    }).catch((e) => {
      console.error("convert error", e);
      questionTextJa.textContent = text;
    });
  } else {
    // ルビOFFなら普通にテキスト
    questionTextJa.textContent = text;
  }
} else {
  // 英語表示
    questionTextJa.style.display = "none";
    questionTextEn.style.display = "block";
    questionTextEn.textContent = q.questionEn || '';
  }

  // この問題専用の勘定科目リストをセット
  const accountList = buildAccountListFromQuestion(q);
  setAccountSelectOptions(accountList);

  // ボタン状態
  langJaBtn.classList.toggle("active", currentLang === "ja");
  langEnBtn.classList.toggle("active", currentLang === "en");
  randomModeCheckbox.checked = randomMode;

  // 入力クリア
  clearEntryInputs();
}

    // 次の問題へ
    function goNextQuestion() {
      if (!questions || questions.length === 0) return;
      historyStack.push(currentIndex); // 戻る用に積む

      if (randomMode) {
        let next;
        if (questions.length === 1) {
          next = 0;
        } else {
          do {
            next = Math.floor(Math.random() * questions.length);
          } while (next === currentIndex);
        }
        currentIndex = next;
      } else {
        currentIndex = (currentIndex + 1) % questions.length;
      }
      renderQuestion();
    }

    // 前の問題へ
    function goPrevQuestion() {
      if (historyStack.length === 0) {
        return;
      }
      const prevIndex = historyStack.pop();
      currentIndex = prevIndex;
      renderQuestion();
    }

    // 入力から仕訳を取得
    function getUserEntries() {
      const debit = [];
      const credit = [];

      for (let i = 1; i <= ENTRY_ROW_COUNT; i++) {
        const dAcc = document.getElementById("debit-account-" + i).value.trim();
        const dAmtStr = document.getElementById("debit-amount-" + i).value.trim();
        const cAcc = document.getElementById("credit-account-" + i).value.trim();
        const cAmtStr = document.getElementById("credit-amount-" + i).value.trim();

        if (dAcc !== "" && dAmtStr !== "") {
          const amt = Number(dAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            debit.push({ account: dAcc, amount: amt });
          }
        }
        if (cAcc !== "" && cAmtStr !== "") {
          const amt = Number(cAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            credit.push({ account: cAcc, amount: amt });
          }
        }
      }

      return { debit, credit };
    }

    // 両側の合計が一致しているか
    function isBalanced(entries) {
      const sum = (list) => list.reduce((acc, e) => acc + e.amount, 0);
      return sum(entries.debit) === sum(entries.credit);
    }

    // 片側比較
    function compareSide(userList, correctList) {
      if (!Array.isArray(correctList)) return false;
      if (userList.length !== correctList.length) return false;

      const remaining = correctList.map((e) => ({ ...e })); // コピー

      for (const u of userList) {
        const index = remaining.findIndex(
          (c) => c.account === u.account && Number(c.amount) === Number(u.amount)
        );
        if (index === -1) {
          return false;
        }
        remaining.splice(index, 1);
      }
      return remaining.length === 0;
    }

    
    // 学習ログ保存（ログイン時のみ）
    async function logStudyResult(q, isCorrect) {
      if (!window.sessionUser) return;

      try {
        const payload = {
          user_id: window.sessionUser.id,
          content_type: 'quiz',       // ← 種別
          content_id: q.id,           // ← 問題ID
          is_correct: isCorrect,
          // answer_json や meta を使いたければここで追加
          // answer_json: getUserEntries(), みたいに入れてもOK（json型）
          completed_at: new Date().toISOString()  // or created_at に任せてもOK        

        };
        
        const { error } = await supabaseClient
          .from('study_logs')
          .insert(payload);
        
        if (error) {
          console.error('study_logs insert error', error);
        } else {
          loadMyHistory();
        }
      } catch (e) {
        console.error('logStudyResult exception', e);
      }
    }


    // ← この下に追加
    // Supabase の solution JSON を { debit: [...], credit: [...] } 形式にそろえる
    function normalizeSolution(raw) {
      if (!raw) return { debit: [], credit: [] };

      let debits = [];
      let credits = [];

      // パターン1: {debits: [...], credits: [...]}
      if (Array.isArray(raw.debits)) debits = raw.debits;
      if (Array.isArray(raw.credits)) credits = raw.credits;

      // パターン2: {debit: [...], credit: [...]}（ハードコード問題用）
      if (debits.length === 0 && Array.isArray(raw.debit)) debits = raw.debit;
      if (credits.length === 0 && Array.isArray(raw.credit)) credits = raw.credit;

      const normalizeSide = (list) =>
        (list || []).map((e) => ({
          account: (e.account || "").trim(),
          amount: Number(e.amount)
        })).filter(e => e.account && !Number.isNaN(e.amount));

      return {
        debit: normalizeSide(debits),
        credit: normalizeSide(credits)
      };
    }
   
    // 答え合わせ
    async function checkAnswer() {
      if (!questions || questions.length === 0) {
        return;
      }
      const q = questions[currentIndex];
      const user = getUserEntries();
      const t = i18n[currentLang];   // ★ 翻訳テーブルを参照

      // 入力なし
      if (user.debit.length === 0 && user.credit.length === 0) {
        resultMessage.textContent = t['msg-input-required'];
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      // 借方・貸方が一致していない
      if (!isBalanced(user)) {
        resultMessage.textContent = t['msg-not-balanced'];
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      // 採点
      // Supabase / ハードコード両対応の模範解答を取得
      const norm = normalizeSolution(q.solution);

      const okDebit = compareSide(user.debit, norm.debit);
      const okCredit = compareSide(user.credit, norm.credit);
      const isCorrect = okDebit && okCredit;

      totalAnswered++;
      if (isCorrect) {
        totalCorrect++;
      }
      updateScore();

      // 正解 / 不正解のメッセージ
      if (isCorrect) {
        resultMessage.textContent = t['msg-correct'];
        resultMessage.className = "result-message ok";
      } else {
        resultMessage.textContent = t['msg-wrong'];
        resultMessage.className = "result-message ng";
      }

      answerJa.textContent = (q.journalJa || '').replace(/<br\s*\/?>/gi, '\n');
      answerEn.textContent = (q.journalEn || '').replace(/<br\s*\/?>/gi, '\n');
      answerPanel.style.display = "block";

      await logStudyResult(q, isCorrect);
    }

    // 自分の履歴読み込み
    async function loadMyHistory() {
      if (!historyListEl) return;

      if (!window.sessionUser) {
        historyListEl.innerHTML =
          '<div style="font-size:0.75rem;color:#666;">ログインすると直近の解答履歴が表示されます。</div>';
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from('study_logs')
          .select('id, content_id, is_correct, completed_at, created_at')
          .eq('user_id', window.sessionUser.id)
          .order('completed_at', { ascending: false })
          .limit(20);

        if (error) {
          console.error('study_logs select error', error);
          historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#c00;">履歴の取得に失敗しました。</div>';
          return;
        }

        if (!data || data.length === 0) {
          historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#666;">まだ履歴がありません。</div>';
          return;
        }

        historyListEl.innerHTML = '';
        data.forEach(row => {
          const div = document.createElement('div');
          div.className = 'history-item';

          const left = document.createElement('span');
          left.textContent = `Q:${row.content_id}`;

          const right = document.createElement('span');
          const flag = document.createElement('span');
          flag.textContent = row.is_correct ? '◯' : '×';
          flag.className = row.is_correct ? 'correct' : 'wrong';
          const dt = document.createElement('span');
          const ts = row.completed_at || row.created_at;
          const d = ts ? new Date(ts) : null;        
          dt.textContent = d ? d.toLocaleString() : '';

          right.appendChild(flag);
          right.appendChild(document.createTextNode(' '));
          right.appendChild(dt);

          div.appendChild(left);
          div.appendChild(right);
          historyListEl.appendChild(div);
        });
      } catch (e) {
        console.error('loadMyHistory exception', e);
        historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#c00;">履歴の取得に失敗しました。</div>';
      }
    }

    // ---------------------------
    // 初期処理
    // ---------------------------
    window.addEventListener('DOMContentLoaded', async () => {
      // DOM 要素の取得
      questionLabel = document.getElementById("question-label");
      categoryLabel = document.getElementById("category-label");
      idLabel = document.getElementById("id-label");
      randomLabel = document.getElementById("random-label");
      questionTextJa = document.getElementById("question-text-ja");
      questionTextEn = document.getElementById("question-text-en");
      langJaBtn = document.getElementById("lang-ja");
      langEnBtn = document.getElementById("lang-en");
      randomModeCheckbox = document.getElementById("random-mode");
      prevBtn = document.getElementById("prev-question");
      nextBtn = document.getElementById("next-question");
      checkBtn = document.getElementById("check-answer");
      resultMessage = document.getElementById("result-message");
      answerPanel = document.getElementById("answer-panel");
      answerJa = document.getElementById("answer-ja");
      answerEn = document.getElementById("answer-en");
      scorePill = document.getElementById("score-pill");
      categoryFilterSelect = document.getElementById("category-filter");
      questionCountSelect = document.getElementById("question-count");
      historyListEl = document.getElementById("history-list");

      const btnLogin = document.getElementById('btn-login');
      const btnLogout = document.getElementById('btn-logout');
      const btnStart = document.getElementById('btn-start-session');

      if (btnLogin) btnLogin.addEventListener('click', signIn);
      if (btnLogout) btnLogout.addEventListener('click', signOut);
      if (btnStart) btnStart.addEventListener('click', startNewSessionFromUI);

      // とりあえず初期のセレクトを作っておく
      initAccountSelects();

      // ここで一度適用
      applyLanguage();

      // イベント登録（言語切り替えなど）
      langJaBtn.addEventListener("click", () => {
        currentLang = "ja";
        applyLanguage();
        renderQuestion();
      });
      langEnBtn.addEventListener("click", () => {
        currentLang = "en";
        applyLanguage();
        renderQuestion();
      });
      randomModeCheckbox.addEventListener("change", (e) => {
        randomMode = e.target.checked;
        renderQuestion();
      });
      nextBtn.addEventListener("click", goNextQuestion);
      prevBtn.addEventListener("click", goPrevQuestion);
      checkBtn.addEventListener("click", checkAnswer);
      
// ルビON/OFFボタン - 修正後
const toggleRubyBtn = document.getElementById("toggle-ruby");
if (toggleRubyBtn) {
  // 初期状態を設定
  toggleRubyBtn.textContent = rubyEnabled ? "ルビ表示：ON" : "ルビ表示：OFF";
  
  toggleRubyBtn.addEventListener("click", async () => {
    if (!rubyEnabled) {
      toggleRubyBtn.disabled = true;
      toggleRubyBtn.textContent = "ルビ初期化中…";
      await new Promise(r => setTimeout(r, 50));
      
      // これから ON にする → まず Kuroshiro を初期化
      try {
        // 30秒でタイムアウト
        await Promise.race([
          initKuroshiro(),
          new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), 30000))
        ]);
        
        rubyEnabled = true;
        toggleRubyBtn.textContent = "ルビ表示：ON";
        renderQuestion();
      } catch (e) {
        console.error(e);
        alert("ルビ初期化に失敗: " + (e?.message || e));
        rubyEnabled = false;
        toggleRubyBtn.textContent = "ルビ表示：OFF";
      }finally {
      toggleRubyBtn.disabled = false;
      }      
    } else {
      // OFF にするだけ
      rubyEnabled = false;
      toggleRubyBtn.textContent = "ルビ表示：OFF";
      console.log("ルビ機能を無効化しました");
      renderQuestion();
    }
  });
}
      
      try {
        // 認証状態取得
        const { data: authData } = await supabaseClient.auth.getUser();
        window.sessionUser = authData.user || null;
        updateAuthUI();

// quiz_questions 取得（account_options カラムも一緒に返ってくる）
const { data, error } = await supabaseClient
  .from('quiz_questions')
  .select('*');

if (error) {
  console.error('Supabase quiz_questions error:', error);
  allQuestions = hardcodedQuestions;
} else if (data && data.length > 0) {
  console.log('取得したクイズ件数:', data.length);

  // ★ ここで solution をオブジェクトに直しておく
  allQuestions = data.map((row) => {
    let solution = row.solution;

    // solution が文字列なら JSON としてパース
    if (typeof solution === 'string') {
      try {
        solution = JSON.parse(solution);
      } catch (e) {
        console.error('solution JSON parse error for id =', row.id, solution, e);
        solution = null;  // 壊れている場合は一旦 null
      }
    }

    // 必要に応じて account_options を配列化（既に文字列で扱えているので必須ではない）
    let account_options = row.account_options;
    if (typeof account_options === 'string') {
      account_options = account_options
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    }

    return {
      ...row,
      solution,
      account_options,
    };
  });

} else {
  console.log('Supabase quiz_questions が空のためハードコード問題を使用します');
  allQuestions = hardcodedQuestions;
}


        setupCategoryFilterOptions(allQuestions);
        startNewSessionFromUI();
        loadMyHistory();
      } catch (e) {
        console.error('初期処理エラー:', e);
        allQuestions = hardcodedQuestions;
        setupCategoryFilterOptions(allQuestions);
        startNewSessionFromUI();
      }
    });
  </script>
</head>
<body>
  <div class="page">
    <header>
      <!-- Liberty ロゴ -->
      <img src="https://liberty-system.co.jp/common/img/logo.png" alt="Liberty" class="logo" />
      <div class="title-block">
        <h1 data-i18n="app-title">Liberty Bookkeeping Trainer</h1>
        <span data-i18n="app-subtitle">留学生・実務家向け 簿記仕訳トレーニング 2.0</span>
      </div>

      <div class="auth-box">
         <!-- ログアウト状態 --> 
        <div id="auth-when-logged-out">
          <input type="email" id="auth-email" placeholder="メールアドレス" />
          <input type="password" id="auth-password" placeholder="パスワード" />
         </div>

         <div class="auth-actions">   
          <button class="auth-primary-btn" id="btn-login">ログイン</button>
          <a href="signup.html" style="font-size:0.75rem; margin-left:4px;">新規登録</a>
          <a href="forgot-password.html" class="auth-link">パスワードをお忘れの方はこちら</a>
          </div>
        </div>

        <!-- ログイン状態 -->
        <div id="auth-when-logged-in" style="display:none;">
          <span id="auth-user-label" class="auth-status"></span>
          <button class="auth-small-btn" id="btn-logout">ログアウト</button>
        </div>
      </div>
    </header>

    <!-- 動画・スライド / 履歴ページへのボタン -->
    <div class="top-nav">
      <a href="contents.html">
        <button class="top-nav-btn">
          <span class="icon">🎥</span>
          <span>動画・スライドを見る</span>
        </button>
      </a>
      <a href="history.html">
        <button class="top-nav-btn">
          <span class="icon">📊</span>
          <span>学習履歴ページへ</span>
        </button>
      </a>
    </div>

    <div class="layout">
      <!-- 左：問題＆入力 -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-title-pill" data-i18n="practice-pill">Practice</span>
            <span id="question-label">問題 0 / 0</span>
          </div>
          <div class="lang-toggle">
            <button id="lang-ja" class="active">日本語</button>
            <button id="lang-en">English</button>
          </div>

          <!-- ルビ表示切替ボタン -->
          <button id="toggle-ruby" class="auth-small-btn" style="margin-left:8px;">
            ルビ表示：OFF
          </button>
          
        </div>

        <!-- 出題条件 -->
        <div class="filter-row">
          <span data-i18n="filter-category">カテゴリ:</span>
          <select id="category-filter"></select>
          <span data-i18n="filter-count">問題数:</span>
          <select id="question-count"></select>
          <button id="btn-start-session" data-i18n="filter-start">出題開始</button>
        </div>

        <div class="question-meta">
          <span class="badge" id="category-label"></span>
          <span id="id-label"></span>
          <span id="random-label"></span>
        </div>

        <div class="question-text" id="question-text-ja">
          <!-- 日本語問題文 -->
        </div>
        <div class="question-text" id="question-text-en" style="display:none;">
          <!-- English question -->
        </div>

        <div class="toggle-row">
          <span data-i18n="toggle-main">借方・貸方の科目と金額を入力してください。</span>
          <label>
            <input type="checkbox" id="random-mode" />
            <span data-i18n="toggle-random">ランダム出題</span>
          </label>
        </div>

        <p class="hint-text" id="hint-text" data-furigana-target>
          行ごとに「借方勘定科目・金額」「貸方勘定科目・金額」を入力します。<br>
          不要な欄は科目を「空欄」のまま、金額も空欄にしておいてください。
        </p>

        <!-- 仕訳入力テーブル -->
        <div class="entry-table">
          <div class="entry-header-row">
            <span data-i18n="entry-col-row">行</span>
            <span data-i18n="entry-col-debit">借方勘定科目</span>
            <span data-i18n="entry-col-debit-amount">金額</span>
            <span data-i18n="entry-col-credit">貸方勘定科目</span>
            <span data-i18n="entry-col-credit-amount">金額</span>
          </div>

          <!-- 4行分用意 -->
          <div class="entry-row">
            <span class="row-label">1</span>
            <select class="account-select" id="debit-account-1"></select>
            <input type="number" id="debit-amount-1" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-1"></select>
            <input type="number" id="credit-amount-1" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">2</span>
            <select class="account-select" id="debit-account-2"></select>
            <input type="number" id="debit-amount-2" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-2"></select>
            <input type="number" id="credit-amount-2" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">3</span>
            <select class="account-select" id="debit-account-3"></select>
            <input type="number" id="debit-amount-3" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-3"></select>
            <input type="number" id="credit-amount-3" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">4</span>
            <select class="account-select" id="debit-account-4"></select>
            <input type="number" id="debit-amount-4" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-4"></select>
            <input type="number" id="credit-amount-4" min="0" inputmode="numeric" />
          </div>
        </div>

        <div class="button-row">
          <button id="prev-question" class="btn btn-secondary" data-i18n="btn-prev">⏮ 前の問題へ</button>
          <button id="check-answer" class="btn btn-primary" data-i18n="btn-check">✔ 答え合わせ</button>
          <button id="next-question" class="btn btn-outline" data-i18n="btn-next">⏭ 次の問題へ</button>
        </div>

        <div id="result-message" class="result-message"></div>

        <div class="answer-panel" id="answer-panel" style="display:none;">
          <h3 data-i18n="answer-title">模範仕訳 / Model Answer</h3>
          <pre id="answer-ja"></pre>
          <pre id="answer-en"></pre>
          <small data-i18n="answer-note">※ 科目名と金額が合致していれば正解です（行の順番は問いません）。</small>
        </div>
      </section>

      <!-- 右：進捗＆履歴 -->
      <aside class="card">
        <div class="side-card-title" data-i18n="progress-title">進捗 / Progress</div>
        <div class="score-box">
          <div class="score-pill" id="score-pill">正解 0 / 0</div>
        </div>
        
        <p id="progress-help"
          data-i18n="progress-help"
          style="font-size:0.8rem; color:var(--text-muted); margin-top:0;">
          ・「出題開始」で選択した条件の問題セットを開始します。<br>
          ・「答え合わせ」で自動判定します。<br>
          ・ランダム出題をONにすると、順番をシャッフルします。<br>
          ・日本語 / 英語はいつでも切り替え可能です。
        </p>

        <div class="history-box-title" data-i18n="history-title">直近の学習履歴</div>
        <div id="history-list" class="history-list">
          <!-- 履歴が入る -->
        </div>
      </aside>
    </div>

    <footer>
      &copy; Liberty Co., Ltd. Bookkeeping Trainer 2.0
    </footer>
  </div>
</body>
</html>


