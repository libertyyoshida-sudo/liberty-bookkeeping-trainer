<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Liberty Bookkeeping Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --primary: #005bac;
      --primary-soft: #e2eef9;
      --accent: #00a0e9;
      --text-main: #222;
      --text-muted: #666;
      --border-soft: #dde3f0;
      --danger: #d9534f;
      --success: #28a745;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.06);
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #e6f0ff, #f5f7fb 40%, #ffffff 80%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    header img.logo {
      height: 40px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 220px;
    }

    header .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--primary);
    }

    header .title-block span {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .auth-box {
      background: #fff;
      border-radius: 16px; /* 999px ã ã¨ç¸¦é•·ãƒœãƒƒã‚¯ã‚¹ãŒã¡ã‚‡ã£ã¨å¤‰ãªã®ã§å°‘ã—å°ã•ã‚ã« */
      padding: 8px 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;        /* â˜…ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
      align-items: stretch;          /* â˜…ä¸­èº«ã‚’å¹…ã„ã£ã±ã„ã« */
      gap: 6px;
      font-size: 0.75rem;
       max-width: 320px;              /* â˜…ã‚¹ãƒãƒ›ã§ã®ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    /* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
    .auth-fields {
      display: flex;
      flex-direction: column;
      gap: 4px;
ã€€ã€€}

    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼†ãƒªãƒ³ã‚¯ãŸã¡ */
   .auth-actions {
     display: flex;
     flex-direction: column;
     gap: 4px;
    } 

   /* auth-boxå†…ã®å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³ã¯å¹…100%ã« */
   .auth-box input,
   .auth-box button {
     width: 100%;
     box-sizing: border-box;
    }

   /* æ–°è¦ç™»éŒ²/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªãƒ³ã‚¯ */
   .auth-link {
     display: block;
     width: 100%;
     text-align: left;
     font-size: 0.75rem;
     color: var(--primary);
     text-decoration: none;
   }

   .auth-link:hover {
     text-decoration: underline;
   }

    .auth-box input {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 4px 8px;
      font-size: 0.75rem;
      min-width: 130px;
    }

    .auth-primary-btn,
    .auth-small-btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 4px 10px;
      white-space: nowrap;
    }

    .auth-primary-btn {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
    }

    .auth-small-btn {
      background: #e2e7f3;
      color: var(--text-main);
    }

    .auth-status {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* ä¸Šéƒ¨ãƒŠãƒ“ãƒœã‚¿ãƒ³ */
    .top-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }

    .top-nav a {
      text-decoration: none;
    }

    .top-nav-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: #ffffff;
      color: var(--primary);
      border: 1px solid rgba(0, 91, 172, 0.25);
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .top-nav-btn span.icon {
      font-size: 0.9rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .auth-box {
        width: 100%;
        justify-content: flex-start;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-pill {
      font-size: 0.75rem;
      color: var(--bg-card);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      padding: 2px 10px;
      border-radius: 999px;
    }

    .lang-toggle {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      background: var(--primary-soft);
    }

    .lang-toggle button {
      border: none;
      padding: 4px 10px;
      border-radius: 999px;
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .lang-toggle button.active {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(0, 91, 172, 0.06);
    }

    .question-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .badge {
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
    }

    .question-text {
      background: linear-gradient(135deg, #f8fbff, #f3f3ff);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(0, 91, 172, 0.08);
      font-size: 0.9rem;
    }

    .question-text p {
      margin: 0 0 4px;
    }

    .question-text p:last-child {
      margin-bottom: 0;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }

    .toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .toggle-row input[type="checkbox"] {
      accent-color: var(--primary);
    }

    /* å‡ºé¡Œæ¡ä»¶ */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      align-items: center;
    }

    .filter-row select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font-size: 0.8rem;
    }

    .filter-row button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e2e7f3;
      color: var(--text-main);
      white-space: nowrap;
    }

    /* ä»•è¨³å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« */
    .entry-table {
      margin: 6px 0 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: #fafbff;
    }

    .entry-header-row,
    .entry-row {
      display: grid;
      grid-template-columns: 40px minmax(0, 1.2fr) 100px minmax(0, 1.2fr) 100px;
      gap: 4px;
      align-items: center;
    }

    .entry-header-row {
      background: #e9f1ff;
      padding: 6px 8px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .entry-row {
      padding: 6px 8px;
      font-size: 0.85rem;
      border-top: 1px solid #edf1fb;
      background: #fff;
    }

    .entry-row:nth-child(even) {
      background: #fdfdff;
    }

    .entry-row span.row-label {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    select,
    input[type="number"] {
      width: 100%;
      font-size: 0.8rem;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border-soft);
      background: #fff;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 91, 172, 0.15);
      background: #f9fcff;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .hint-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 91, 172, 0.35);
    }

    .btn-secondary {
      background: #e2e7f3;
      color: var(--text-main);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid rgba(0, 91, 172, 0.2);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .result-message {
      font-size: 0.9rem;
      margin-top: 4px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .result-message.ok {
      color: var(--success);
    }

    .result-message.ng {
      color: var(--danger);
    }

    .answer-panel {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f7f9ff;
      border: 1px dashed rgba(0, 91, 172, 0.25);
      font-size: 0.8rem;
    }

    .answer-panel h3 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .answer-panel pre {
      margin: 0 0 6px;
      background: #fff;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.8rem;
      overflow-x: auto;
    }

    .answer-panel small {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .side-card-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .score-box {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .score-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
    }

    .history-box-title {
      margin-top: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .history-list {
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      background: #f9fbff;
      font-size: 0.75rem;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      padding: 3px 0;
      border-bottom: 1px dashed #e1e5f0;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-item span.correct {
      color: var(--success);
      font-weight: 600;
    }

    .history-item span.wrong {
      color: var(--danger);
      font-weight: 600;
    }

    footer {
      margin-top: 18px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: center;
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
  <script src="https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
  <script>
    const SUPABASE_URL = "https://uczxiifxjzwbarkstvnt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjenhpaWZ4anp3YmFya3N0dm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NTcwODQsImV4cCI6MjA3OTQzMzA4NH0.UCMjF7gaU7HstTPG16QuKi9Idxyl-Zh9AG7XjmvJ1UU";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ç”»é¢æ–‡è¨€ã®å¤šè¨€èªå¯¾å¿œ
const i18n = {
  ja: {
    'app-title': 'Liberty Bookkeeping Trainer',
    'app-subtitle': 'ç•™å­¦ç”Ÿãƒ»å®Ÿå‹™å®¶å‘ã‘ ç°¿è¨˜ä»•è¨³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° 2.0',
    'practice-pill': 'Practice',
    'question-label-prefix': 'å•é¡Œ',       // ã€Œå•é¡Œ 1 / 10ã€ã®ã€Œå•é¡Œã€éƒ¨åˆ†
    'filter-category': 'ã‚«ãƒ†ã‚´ãƒª:',
    'filter-count': 'å•é¡Œæ•°:',
    'filter-start': 'å‡ºé¡Œé–‹å§‹',
    'toggle-main': 'å€Ÿæ–¹ãƒ»è²¸æ–¹ã®ç§‘ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
    'toggle-random': 'ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ',
    'hint-text':
      'è¡Œã”ã¨ã«ã€Œå€Ÿæ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã€Œè²¸æ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚\nä¸è¦ãªæ¬„ã¯ç§‘ç›®ã‚’ã€Œç©ºæ¬„ã€ã®ã¾ã¾ã€é‡‘é¡ã‚‚ç©ºæ¬„ã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚',
    'entry-col-row': 'è¡Œ',
    'entry-col-debit': 'å€Ÿæ–¹å‹˜å®šç§‘ç›®',
    'entry-col-debit-amount': 'é‡‘é¡',
    'entry-col-credit': 'è²¸æ–¹å‹˜å®šç§‘ç›®',
    'entry-col-credit-amount': 'é‡‘é¡',
    'btn-prev': 'â® å‰ã®å•é¡Œã¸',
    'btn-check': 'âœ” ç­”ãˆåˆã‚ã›',
    'btn-next': 'â­ æ¬¡ã®å•é¡Œã¸',
    'answer-title': 'æ¨¡ç¯„ä»•è¨³ / Model Answer',
    'answer-note': 'â€» ç§‘ç›®åã¨é‡‘é¡ãŒåˆè‡´ã—ã¦ã„ã‚Œã°æ­£è§£ã§ã™ï¼ˆè¡Œã®é †ç•ªã¯å•ã„ã¾ã›ã‚“ï¼‰ã€‚',
    'progress-title': 'é€²æ— / Progress',
    'history-title': 'ç›´è¿‘ã®å­¦ç¿’å±¥æ­´',
    'history-not-logged-in': 'ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç›´è¿‘ã®è§£ç­”å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚',
    'history-none': 'ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚',
    'footer': 'Â© Liberty Co., Ltd. Bookkeeping Trainer 2.0',
    'progress-title': 'é€²æ— / Progress',
    'progress-help':
      'ãƒ»ã€Œå‡ºé¡Œé–‹å§‹ã€ã§é¸æŠã—ãŸæ¡ä»¶ã®å•é¡Œã‚»ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚\n' +
      'ãƒ»ã€Œç­”ãˆåˆã‚ã›ã€ã§è‡ªå‹•åˆ¤å®šã—ã¾ã™ã€‚\n' +
      'ãƒ»ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã‚’ONã«ã™ã‚‹ã¨ã€é †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚\n' +
      'ãƒ»æ—¥æœ¬èª / è‹±èªã¯ã„ã¤ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã§ã™ã€‚',
    'history-title': 'ç›´è¿‘ã®å­¦ç¿’å±¥æ­´',

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç³»
    'msg-input-required': 'ç§‘ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
    'msg-not-balanced': 'å€Ÿæ–¹åˆè¨ˆã¨è²¸æ–¹åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
    'msg-correct': 'â— æ­£è§£ã§ã™ï¼ ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã€‚',
    'msg-wrong': 'Ã— æƒœã—ã„ã§ã™ã€‚æ¨¡ç¯„ä»•è¨³ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
    'score': (correct, total) => `æ­£è§£ ${correct} / ${total}`
  },
  en: {
    'app-title': 'Liberty Bookkeeping Trainer',
    'app-subtitle': 'Bookkeeping Journal Entry Trainer for International Students & Practitioners',
    'practice-pill': 'Practice',
    'question-label-prefix': 'Question',
    'filter-category': 'Category:',
    'filter-count': 'Number of questions:',
    'filter-start': 'Start',
    'toggle-main': 'Enter the accounts and amounts for debit and credit.',
    'toggle-random': 'Random order',
    'hint-text':
      'For each row, enter â€œdebit account / amountâ€ and â€œcredit account / amountâ€.\nIf a row is not needed, leave both the account and amount blank.',
    'entry-col-row': 'Row',
    'entry-col-debit': 'Debit account',
    'entry-col-debit-amount': 'Amount',
    'entry-col-credit': 'Credit account',
    'entry-col-credit-amount': 'Amount',
    'btn-prev': 'â® Previous',
    'btn-check': 'âœ” Check answer',
    'btn-next': 'â­ Next',
    'answer-title': 'Model Answer',
    'answer-note': 'If both account names and amounts match, it is correct (row order does not matter).',
    'progress-title': 'Progress',
    'history-title': 'Recent study history',
    'history-not-logged-in': 'Log in to see your recent answer history.',
    'history-none': 'No history yet.',
    'footer': 'Â© Liberty Co., Ltd. Bookkeeping Trainer 2.0',
    'progress-title': 'Progress',
    'progress-help':
      'ãƒ»Click "Start" to begin questions with the selected conditions.\n' +
      'ãƒ»Click "Check answer" to auto-grade your entry.\n' +
      'ãƒ»Turn on "Random order" to shuffle questions.\n' +
      'ãƒ»You can switch between Japanese / English at any time.',
    'history-title': 'Recent study history',

    'msg-input-required': 'Please enter both account names and amounts.',
    'msg-not-balanced': 'Debit total and credit total do not match. Please check again.',
    'msg-correct': 'â— Correct! Well done.',
    'msg-wrong': 'Ã— Almost. Check the model journal entry.',
    'score': (correct, total) => `Correct ${correct} / ${total}`
  }
};
    
    // ---------------------------
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    // ---------------------------
    window.sessionUser = null;

    // Supabase ã‹ã‚‰å–å¾—ã™ã‚‹å…¨å•é¡Œ
    let allQuestions = [];

    // ä»•è¨³å…¥åŠ›ã®è¡Œæ•°ï¼ˆå°†æ¥ 5 è¡Œã€6 è¡Œã«ã—ãŸã‘ã‚Œã°ã“ã“ã‚’å¤‰ãˆã‚‹ï¼‰
    const ENTRY_ROW_COUNT = 4;   // ä»Šã¯ 4 è¡Œã«ã—ãŸã„

    // ä»Šå›ã®å‡ºé¡Œã‚»ãƒƒãƒˆ
    let questions = [];

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å•é¡Œ
    const hardcodedQuestions = [
      {
        id: "2-1",
        categoryJa: "æ—¥ã€…ã®ä»•è¨³",
        categoryEn: "Daily entries",
        titleJa: "2-1 å£²ä¸Šï¼ˆç¾é‡‘ï¼‹ãƒã‚¤ãƒ³ãƒˆï¼‰",
        titleEn: "2-1 Sales (cash + point)",
        questionJa:
          "å•†å“ã‚’ 1,100å††ã§è²©å£²ã—ã€ãã®ä»£é‡‘ã®ã†ã¡ 100å††ã‚’ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨ã€æ®‹ã‚Š 1,000å††ã‚’ç¾é‡‘ã§å—ã‘å–ã£ãŸã€‚100å††ã®ãƒã‚¤ãƒ³ãƒˆã¯ä»–ç¤¾ãŒç™ºè¡Œã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã§å¾Œæ—¥å…¥é‡‘ã•ã‚Œã‚‹ã€‚",
        questionEn:
          "A product was sold for 1,100 yen. 100 yen was paid using points issued by another company (to be received later in cash), and the remaining 1,000 yen was received in cash.",
        solution: {
          debit: [
            { account: "å£²æ›é‡‘", amount: 100 },
            { account: "ç¾é‡‘", amount: 1000 }
          ],
          credit: [
            { account: "å£²ä¸Š", amount: 1100 }
          ]
        },
        journalJa: "å€Ÿæ–¹ï¼šå£²æ›é‡‘ 100ã€€ç¾é‡‘ 1,000ã€€/ã€€è²¸æ–¹ï¼šå£²ä¸Š 1,100",
        journalEn: "Debit: Accounts Receivable 100, Cash 1,000 / Credit: Sales 1,100",
        account_options: "ç¾é‡‘,å£²æ›é‡‘,å£²ä¸Š"
      }
      // â€¦å¿…è¦ãªã‚‰ä»–ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å•é¡Œã«ã‚‚ account_options ã‚’è¿½åŠ 
    ];

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹˜å®šç§‘ç›®ãƒã‚¹ã‚¿ãƒ¼ï¼ˆaccount_options æœªè¨­å®šã®å•é¡Œç”¨ï¼‰
    const accountMaster = [
      "",
      "ç¾é‡‘",
      "æ™®é€šé é‡‘",
      "å£²æ›é‡‘",
      "è²·æ›é‡‘",
      "æœªæ‰•é‡‘",
      "ä»•å…¥",
      "å£²ä¸Š",
      "æ¶ˆè€—å“è²»"
    ];

    // çŠ¶æ…‹
    let currentIndex = 0;
    let currentLang = "ja";
    let randomMode = false;
    let historyStack = []; // æˆ»ã‚‹ç”¨ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç©ã‚€
    let totalAnswered = 0;
    let totalCorrect = 0;

    // DOM å–å¾—ï¼ˆå¾Œã§åŸ‹ã¾ã‚‹ã®ã§ let ã§å®£è¨€ã ã‘ã—ã¦ãŠãï¼‰
    let questionLabel, categoryLabel, idLabel, randomLabel;
    let questionTextJa, questionTextEn;
    let langJaBtn, langEnBtn, randomModeCheckbox;
    let prevBtn, nextBtn, checkBtn;
    let resultMessage, answerPanel, answerJa, answerEn, scorePill;
    let categoryFilterSelect, questionCountSelect, historyListEl;

    // ---------------------------
    // èªè¨¼ã¾ã‚ã‚Š
    // ---------------------------
    function updateAuthUI() {
      const authLoggedOut = document.getElementById('auth-when-logged-out');
      const authLoggedIn = document.getElementById('auth-when-logged-in');
      const authUserLabel = document.getElementById('auth-user-label');

      if (!authLoggedOut || !authLoggedIn || !authUserLabel) return;

      if (window.sessionUser) {
        authLoggedOut.style.display = 'none';
        authLoggedIn.style.display = 'flex';
        authUserLabel.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${window.sessionUser.email || ''}`;
      } else {
        authLoggedOut.style.display = 'flex';
        authLoggedIn.style.display = 'none';
        authUserLabel.textContent = '';
      }
    }

    async function signIn() {
      const emailInput = document.getElementById('auth-email');
      const passwordInput = document.getElementById('auth-password');
      if (!emailInput || !passwordInput) return;

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        console.error('signIn error', error);
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return;
      }

      window.sessionUser = data.user;
      updateAuthUI();
      loadMyHistory();
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚');
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      window.sessionUser = null;
      updateAuthUI();
      loadMyHistory();
      alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
    }

    // ---------------------------
    // å‹˜å®šç§‘ç›®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é–¢é€£
    // ---------------------------

    // å•é¡Œãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€Œã“ã®å•é¡Œã§ä½¿ãˆã‚‹å‹˜å®šç§‘ç›®ãƒªã‚¹ãƒˆã€ã‚’ç”Ÿæˆ
    function buildAccountListFromQuestion(q) {
      let list = [];

      if (q && q.account_options) {
        if (Array.isArray(q.account_options)) {
          // account_options ãŒ JSON é…åˆ—ã®å ´åˆ
          list = q.account_options;
        } else if (typeof q.account_options === 'string') {
          // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã®å ´åˆ
          list = q.account_options
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);
        }
      }

      // account_options ãŒç©ºãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¹ã‚¿ãƒ¼ã‚’ä½¿ç”¨
      if (!list || list.length === 0) {
        list = accountMaster.slice(1); // ç©ºæ¬„ä»¥å¤–ã‚’ãƒ™ãƒ¼ã‚¹ã«
      }

      // é‡è¤‡é™¤å»
      const unique = Array.from(new Set(list));

      // å…ˆé ­ã«ã€Œç©ºæ¬„ã€ã‚’è¿½åŠ 
      unique.unshift("");

      return unique;
    }

    // æ¸¡ã•ã‚ŒãŸå‹˜å®šç§‘ç›®ãƒªã‚¹ãƒˆã§ã€å…¨ã¦ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰
    function setAccountSelectOptions(accountList) {
      const selects = document.querySelectorAll(".account-select");
      selects.forEach((sel) => {
        const currentValue = sel.value; // ä¸€å¿œé€€é¿

        sel.innerHTML = "";
        accountList.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name === "" ? "ï¼ˆç©ºæ¬„ï¼‰" : name;
          sel.appendChild(opt);
        });

        // ã‚‚ã—å…ƒã®å€¤ãŒã¾ã ãƒªã‚¹ãƒˆã«å­˜åœ¨ã™ã‚‹ãªã‚‰ã€å¾©å…ƒã—ã¦ã‚‚ã‚ˆã„
        if (accountList.includes(currentValue)) {
          sel.value = currentValue;
        }
      });
    }

    // åˆæœŸåŒ–ç”¨ï¼ˆæœ€åˆã«ä½•ã‚‚å•é¡ŒãŒãªã„çŠ¶æ…‹ã§å‘¼ã¶ï¼‰
    function initAccountSelects() {
      setAccountSelectOptions(accountMaster);
    }

    // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
    function clearEntryInputs() {
      for (let i = 1; i <= ENTRY_ROW_COUNT; i++) {
        document.getElementById("debit-account-" + i).value = "";
        document.getElementById("debit-amount-" + i).value = "";
        document.getElementById("credit-account-" + i).value = "";
        document.getElementById("credit-amount-" + i).value = "";
      }
      resultMessage.textContent = "";
      resultMessage.className = "result-message";
      answerPanel.style.display = "none";
    }

    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°
    function updateScore() {
      if (!scorePill) return;
      scorePill.textContent = `æ­£è§£ ${totalCorrect} / ${totalAnswered}`;
    }

    // å‡ºé¡Œã‚«ãƒ†ã‚´ãƒªãƒ»å•é¡Œæ•°ã®é¸æŠè‚¢ã‚’ã‚»ãƒƒãƒˆ
    function setupCategoryFilterOptions(all) {
      if (!categoryFilterSelect || !questionCountSelect) return;

      // ã‚«ãƒ†ã‚´ãƒª
      const cats = new Set();
      all.forEach(q => {
        if (q.categoryJa) cats.add(q.categoryJa);
      });

      categoryFilterSelect.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª';
      categoryFilterSelect.appendChild(optAll);

      [...cats].sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        categoryFilterSelect.appendChild(opt);
      });

      // å•é¡Œæ•°
      questionCountSelect.innerHTML = '';
      [5, 10, 20, 50].forEach(n => {
        const opt = document.createElement('option');
        opt.value = String(n);
        opt.textContent = `æœ€å¤§ ${n}å•`;
        questionCountSelect.appendChild(opt);
      });
      const optAllQ = document.createElement('option');
      optAllQ.value = 'all';
      optAllQ.textContent = 'å…¨ä»¶';
      questionCountSelect.appendChild(optAllQ);

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      questionCountSelect.value = '10';
    }

    // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // å‡ºé¡Œã‚»ãƒƒãƒˆä½œæˆ
    function createQuestionSetFromUI() {
      if (!allQuestions || allQuestions.length === 0) {
        questions = [];
        return;
      }
      const cat = categoryFilterSelect ? categoryFilterSelect.value : '';
      const countValue = questionCountSelect ? questionCountSelect.value : '10';

      let pool = allQuestions;
      if (cat) {
        pool = pool.filter(q => q.categoryJa === cat);
      }

      if (pool.length === 0) {
        questions = [];
        return;
      }

      shuffleArray(pool);
      let maxCount = pool.length;
      if (countValue !== 'all') {
        const n = Number(countValue);
        if (!Number.isNaN(n)) {
          maxCount = Math.min(n, pool.length);
        }
      }
      questions = pool.slice(0, maxCount);
      currentIndex = 0;
      historyStack = [];
    }

    // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆUIæ“ä½œã‹ã‚‰ï¼‰
    function startNewSessionFromUI() {
      createQuestionSetFromUI();
      if (!questions || questions.length === 0) {
        questionLabel.textContent = 'å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        questionTextJa.textContent = '';
        questionTextEn.textContent = '';
        categoryLabel.textContent = '';
        idLabel.textContent = '';
        randomLabel.textContent = '';
        initAccountSelects();
        clearEntryInputs();
        return;
      }
      totalAnswered = 0;
      totalCorrect = 0;
      updateScore();
      renderQuestion();
    }
    
//è¨€èªé©ç”¨é–¢æ•° applyLanguage ã‚’ä½œã‚‹
function applyLanguage() {
  const t = i18n[currentLang];

  // data-i18n ä»˜ãè¦ç´ ã®å…±é€šå‡¦ç†
  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.dataset.i18n;
    const value = t[key];
    if (!value) return;

    // æ”¹è¡Œã‚’ <br> ã«ã—ãŸã„è¦ç´ ã‚‚ã‚ã‚‹ã®ã§å°‘ã—åˆ†å²
    if (el.id === 'hint-text' || el.id === 'progress-help') {
      el.innerHTML = value.replace(/\n/g, '<br>');
    } else {
      el.textContent = value;
    }
  });

  // ã‚¹ã‚³ã‚¢è¡¨ç¤º
  if (scorePill) {
    scorePill.textContent = t.score(totalCorrect, totalAnswered);
  }

  // å±¥æ­´ã‚¨ãƒªã‚¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ã¨ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ï¼‰ã¯ loadMyHistory å†…ã§ t ã‚’ä½¿ã†å½¢ã§ã‚‚OK
}
    
    // ç”»é¢ã¸å•é¡Œã‚’åæ˜ 
    function renderQuestion() {
      if (!questions || questions.length === 0) {
        questionLabel.textContent = 'å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      const q = questions[currentIndex];
      questionLabel.textContent = `å•é¡Œ ${currentIndex + 1} / ${questions.length}`;
      categoryLabel.textContent = currentLang === "ja" ? (q.categoryJa || '') : (q.categoryEn || '');
      idLabel.textContent = `ID: ${q.id || ''}`;
      randomLabel.textContent = randomMode ? "ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œä¸­ï¼‰" : "";

      questionTextJa.textContent = q.questionJa || '';
      questionTextEn.textContent = q.questionEn || '';

      if (currentLang === "ja") {
        questionTextJa.style.display = "block";
        questionTextEn.style.display = "none";
      } else {
        questionTextJa.style.display = "none";
        questionTextEn.style.display = "block";
      }

      // ã“ã®å•é¡Œå°‚ç”¨ã®å‹˜å®šç§‘ç›®ãƒªã‚¹ãƒˆã‚’ã‚»ãƒƒãƒˆ
      const accountList = buildAccountListFromQuestion(q);
      setAccountSelectOptions(accountList);

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹
      langJaBtn.classList.toggle("active", currentLang === "ja");
      langEnBtn.classList.toggle("active", currentLang === "en");
      randomModeCheckbox.checked = randomMode;

      // å…¥åŠ›ã‚¯ãƒªã‚¢
      clearEntryInputs();
    }

    // æ¬¡ã®å•é¡Œã¸
    function goNextQuestion() {
      if (!questions || questions.length === 0) return;
      historyStack.push(currentIndex); // æˆ»ã‚‹ç”¨ã«ç©ã‚€

      if (randomMode) {
        let next;
        if (questions.length === 1) {
          next = 0;
        } else {
          do {
            next = Math.floor(Math.random() * questions.length);
          } while (next === currentIndex);
        }
        currentIndex = next;
      } else {
        currentIndex = (currentIndex + 1) % questions.length;
      }
      renderQuestion();
    }

    // å‰ã®å•é¡Œã¸
    function goPrevQuestion() {
      if (historyStack.length === 0) {
        return;
      }
      const prevIndex = historyStack.pop();
      currentIndex = prevIndex;
      renderQuestion();
    }

    // å…¥åŠ›ã‹ã‚‰ä»•è¨³ã‚’å–å¾—
    function getUserEntries() {
      const debit = [];
      const credit = [];

      for (let i = 1; i <= ENTRY_ROW_COUNT; i++) {
        const dAcc = document.getElementById("debit-account-" + i).value.trim();
        const dAmtStr = document.getElementById("debit-amount-" + i).value.trim();
        const cAcc = document.getElementById("credit-account-" + i).value.trim();
        const cAmtStr = document.getElementById("credit-amount-" + i).value.trim();

        if (dAcc !== "" && dAmtStr !== "") {
          const amt = Number(dAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            debit.push({ account: dAcc, amount: amt });
          }
        }
        if (cAcc !== "" && cAmtStr !== "") {
          const amt = Number(cAmtStr);
          if (!Number.isNaN(amt) && amt > 0) {
            credit.push({ account: cAcc, amount: amt });
          }
        }
      }

      return { debit, credit };
    }

    // ä¸¡å´ã®åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹
    function isBalanced(entries) {
      const sum = (list) => list.reduce((acc, e) => acc + e.amount, 0);
      return sum(entries.debit) === sum(entries.credit);
    }

    // ç‰‡å´æ¯”è¼ƒ
    function compareSide(userList, correctList) {
      if (!Array.isArray(correctList)) return false;
      if (userList.length !== correctList.length) return false;

      const remaining = correctList.map((e) => ({ ...e })); // ã‚³ãƒ”ãƒ¼

      for (const u of userList) {
        const index = remaining.findIndex(
          (c) => c.account === u.account && Number(c.amount) === Number(u.amount)
        );
        if (index === -1) {
          return false;
        }
        remaining.splice(index, 1);
      }
      return remaining.length === 0;
    }

    
    // å­¦ç¿’ãƒ­ã‚°ä¿å­˜ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ï¼‰
    async function logStudyResult(q, isCorrect) {
      if (!window.sessionUser) return;

      try {
        const payload = {
          user_id: window.sessionUser.id,
          content_type: 'quiz',       // â† ç¨®åˆ¥
          content_id: q.id,           // â† å•é¡ŒID
          is_correct: isCorrect,
          // answer_json ã‚„ meta ã‚’ä½¿ã„ãŸã‘ã‚Œã°ã“ã“ã§è¿½åŠ 
          // answer_json: getUserEntries(), ã¿ãŸã„ã«å…¥ã‚Œã¦ã‚‚OKï¼ˆjsonå‹ï¼‰
          completed_at: new Date().toISOString()  // or created_at ã«ä»»ã›ã¦ã‚‚OK        

        };
        
        const { error } = await supabaseClient
          .from('study_logs')
          .insert(payload);
        
        if (error) {
          console.error('study_logs insert error', error);
        } else {
          loadMyHistory();
        }
      } catch (e) {
        console.error('logStudyResult exception', e);
      }
    }

    // ç‰‡å´æ¯”è¼ƒ
    function compareSide(userList, correctList) {
      if (!Array.isArray(correctList)) return false;
      if (userList.length !== correctList.length) return false;

      const remaining = correctList.map((e) => ({ ...e })); // ã‚³ãƒ”ãƒ¼

      for (const u of userList) {
        const index = remaining.findIndex(
          (c) => c.account === u.account && Number(c.amount) === Number(u.amount)
        );
        if (index === -1) {
          return false;
        }
        remaining.splice(index, 1);
      }
      return remaining.length === 0;
    }

    // â† ã“ã®ä¸‹ã«è¿½åŠ 
    // Supabase ã® solution JSON ã‚’ { debit: [...], credit: [...] } å½¢å¼ã«ãã‚ãˆã‚‹
    function normalizeSolution(raw) {
      if (!raw) return { debit: [], credit: [] };

      let debits = [];
      let credits = [];

      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: {debits: [...], credits: [...]}
      if (Array.isArray(raw.debits)) debits = raw.debits;
      if (Array.isArray(raw.credits)) credits = raw.credits;

      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: {debit: [...], credit: [...]}ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å•é¡Œç”¨ï¼‰
      if (debits.length === 0 && Array.isArray(raw.debit)) debits = raw.debit;
      if (credits.length === 0 && Array.isArray(raw.credit)) credits = raw.credit;

      const normalizeSide = (list) =>
        (list || []).map((e) => ({
          account: (e.account || "").trim(),
          amount: Number(e.amount)
        })).filter(e => e.account && !Number.isNaN(e.amount));

      return {
        debit: normalizeSide(debits),
        credit: normalizeSide(credits)
      };
    }
   
    // ç­”ãˆåˆã‚ã›
    async function checkAnswer() {
      if (!questions || questions.length === 0) {
        return;
      }
      const q = questions[currentIndex];
      const user = getUserEntries();
      const t = i18n[currentLang];   // â˜… ç¿»è¨³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§

      // å…¥åŠ›ãªã—
      if (user.debit.length === 0 && user.credit.length === 0) {
        resultMessage.textContent = t['msg-input-required'];
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      // å€Ÿæ–¹ãƒ»è²¸æ–¹ãŒä¸€è‡´ã—ã¦ã„ãªã„
      if (!isBalanced(user)) {
        resultMessage.textContent = t['msg-not-balanced'];
        resultMessage.className = "result-message ng";
        answerPanel.style.display = "none";
        return;
      }

      // æ¡ç‚¹
      // Supabase / ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ä¸¡å¯¾å¿œã®æ¨¡ç¯„è§£ç­”ã‚’å–å¾—
      const norm = normalizeSolution(q.solution);

      const okDebit = compareSide(user.debit, norm.debit);
      const okCredit = compareSide(user.credit, norm.credit);
      const isCorrect = okDebit && okCredit;

      totalAnswered++;
      if (isCorrect) {
        totalCorrect++;
      }
      updateScore();

      // æ­£è§£ / ä¸æ­£è§£ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (isCorrect) {
        resultMessage.textContent = t['msg-correct'];
        resultMessage.className = "result-message ok";
      } else {
        resultMessage.textContent = t['msg-wrong'];
        resultMessage.className = "result-message ng";
      }

      answerJa.textContent = (q.journalJa || '').replace(/<br\s*\/?>/gi, '\n');
      answerEn.textContent = (q.journalEn || '').replace(/<br\s*\/?>/gi, '\n');
      answerPanel.style.display = "block";

      await logStudyResult(q, isCorrect);
    }

    // è‡ªåˆ†ã®å±¥æ­´èª­ã¿è¾¼ã¿
    async function loadMyHistory() {
      if (!historyListEl) return;

      if (!window.sessionUser) {
        historyListEl.innerHTML =
          '<div style="font-size:0.75rem;color:#666;">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ç›´è¿‘ã®è§£ç­”å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>';
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from('study_logs')
          .select('id, content_id, is_correct, completed_at, created_at')
          .eq('user_id', window.sessionUser.id)
          .order('answered_at', { ascending: false })
          .limit(20);

        if (error) {
          console.error('study_logs select error', error);
          historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#c00;">å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
          return;
        }

        if (!data || data.length === 0) {
          historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#666;">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
          return;
        }

        historyListEl.innerHTML = '';
        data.forEach(row => {
          const div = document.createElement('div');
          div.className = 'history-item';

          const left = document.createElement('span');
          left.textContent = `Q:${row.question_id}`;

          const right = document.createElement('span');
          const flag = document.createElement('span');
          flag.textContent = row.is_correct ? 'â—¯' : 'Ã—';
          flag.className = row.is_correct ? 'correct' : 'wrong';
          const dt = document.createElement('span');
          const ts = row.completed_at || row.created_at;
          const d = ts ? new Date(ts) : null;        
          dt.textContent = d ? d.toLocaleString() : '';

          right.appendChild(flag);
          right.appendChild(document.createTextNode(' '));
          right.appendChild(dt);

          div.appendChild(left);
          div.appendChild(right);
          historyListEl.appendChild(div);
        });
      } catch (e) {
        console.error('loadMyHistory exception', e);
        historyListEl.innerHTML = '<div style="font-size:0.75rem;color:#c00;">å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
      }
    }

    // ---------------------------
    // åˆæœŸå‡¦ç†
    // ---------------------------
    window.addEventListener('DOMContentLoaded', async () => {
      // DOM è¦ç´ ã®å–å¾—
      questionLabel = document.getElementById("question-label");
      categoryLabel = document.getElementById("category-label");
      idLabel = document.getElementById("id-label");
      randomLabel = document.getElementById("random-label");
      questionTextJa = document.getElementById("question-text-ja");
      questionTextEn = document.getElementById("question-text-en");
      langJaBtn = document.getElementById("lang-ja");
      langEnBtn = document.getElementById("lang-en");
      randomModeCheckbox = document.getElementById("random-mode");
      prevBtn = document.getElementById("prev-question");
      nextBtn = document.getElementById("next-question");
      checkBtn = document.getElementById("check-answer");
      resultMessage = document.getElementById("result-message");
      answerPanel = document.getElementById("answer-panel");
      answerJa = document.getElementById("answer-ja");
      answerEn = document.getElementById("answer-en");
      scorePill = document.getElementById("score-pill");
      categoryFilterSelect = document.getElementById("category-filter");
      questionCountSelect = document.getElementById("question-count");
      historyListEl = document.getElementById("history-list");

      const btnLogin = document.getElementById('btn-login');
      const btnLogout = document.getElementById('btn-logout');
      const btnStart = document.getElementById('btn-start-session');

      if (btnLogin) btnLogin.addEventListener('click', signIn);
      if (btnLogout) btnLogout.addEventListener('click', signOut);
      if (btnStart) btnStart.addEventListener('click', startNewSessionFromUI);

      // ã¨ã‚Šã‚ãˆãšåˆæœŸã®ã‚»ãƒ¬ã‚¯ãƒˆã‚’ä½œã£ã¦ãŠã
      initAccountSelects();

      // ã“ã“ã§ä¸€åº¦é©ç”¨
      applyLanguage();

      // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆè¨€èªåˆ‡ã‚Šæ›¿ãˆãªã©ï¼‰
      langJaBtn.addEventListener("click", () => {
        currentLang = "ja";
        applyLanguage();
        renderQuestion();
      });
      langEnBtn.addEventListener("click", () => {
        currentLang = "en";
        applyLanguage();
        renderQuestion();
      });
      randomModeCheckbox.addEventListener("change", (e) => {
        randomMode = e.target.checked;
        renderQuestion();
      });
      nextBtn.addEventListener("click", goNextQuestion);
      prevBtn.addEventListener("click", goPrevQuestion);
      checkBtn.addEventListener("click", checkAnswer);

      try {
        // èªè¨¼çŠ¶æ…‹å–å¾—
        const { data: authData } = await supabaseClient.auth.getUser();
        window.sessionUser = authData.user || null;
        updateAuthUI();

// quiz_questions å–å¾—ï¼ˆaccount_options ã‚«ãƒ©ãƒ ã‚‚ä¸€ç·’ã«è¿”ã£ã¦ãã‚‹ï¼‰
const { data, error } = await supabaseClient
  .from('quiz_questions')
  .select('*');

if (error) {
  console.error('Supabase quiz_questions error:', error);
  allQuestions = hardcodedQuestions;
} else if (data && data.length > 0) {
  console.log('å–å¾—ã—ãŸã‚¯ã‚¤ã‚ºä»¶æ•°:', data.length);

  // â˜… ã“ã“ã§ solution ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç›´ã—ã¦ãŠã
  allQuestions = data.map((row) => {
    let solution = row.solution;

    // solution ãŒæ–‡å­—åˆ—ãªã‚‰ JSON ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
    if (typeof solution === 'string') {
      try {
        solution = JSON.parse(solution);
      } catch (e) {
        console.error('solution JSON parse error for id =', row.id, solution, e);
        solution = null;  // å£Šã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸€æ—¦ null
      }
    }

    // å¿…è¦ã«å¿œã˜ã¦ account_options ã‚’é…åˆ—åŒ–ï¼ˆæ—¢ã«æ–‡å­—åˆ—ã§æ‰±ãˆã¦ã„ã‚‹ã®ã§å¿…é ˆã§ã¯ãªã„ï¼‰
    let account_options = row.account_options;
    if (typeof account_options === 'string') {
      account_options = account_options
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    }

    return {
      ...row,
      solution,
      account_options,
    };
  });

} else {
  console.log('Supabase quiz_questions ãŒç©ºã®ãŸã‚ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å•é¡Œã‚’ä½¿ç”¨ã—ã¾ã™');
  allQuestions = hardcodedQuestions;
}


        setupCategoryFilterOptions(allQuestions);
        startNewSessionFromUI();
        loadMyHistory();
      } catch (e) {
        console.error('åˆæœŸå‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        allQuestions = hardcodedQuestions;
        setupCategoryFilterOptions(allQuestions);
        startNewSessionFromUI();
      }
    });
  </script>
</head>
<body>
  <div class="page">
    <header>
      <!-- Liberty ãƒ­ã‚´ -->
      <img src="https://liberty-system.co.jp/common/img/logo.png" alt="Liberty" class="logo" />
      <div class="title-block">
        <h1 data-i18n="app-title">Liberty Bookkeeping Trainer</h1>
        <span data-i18n="app-subtitle">ç•™å­¦ç”Ÿãƒ»å®Ÿå‹™å®¶å‘ã‘ ç°¿è¨˜ä»•è¨³ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° 2.0</span>
      </div>

      <div class="auth-box">
         <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ --> 
        <div id="auth-when-logged-out">
          <input type="email" id="auth-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
          <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
         </div>

         <div class="auth-actions">   
          <button class="auth-primary-btn" id="btn-login">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <a href="signup.html" style="font-size:0.75rem; margin-left:4px;">æ–°è¦ç™»éŒ²</a>
          <a href="forgot-password.html" class="auth-link">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã®æ–¹ã¯ã“ã¡ã‚‰</a>
          </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ -->
        <div id="auth-when-logged-in" style="display:none;">
          <span id="auth-user-label" class="auth-status"></span>
          <button class="auth-small-btn" id="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </header>

    <!-- å‹•ç”»ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ / å±¥æ­´ãƒšãƒ¼ã‚¸ã¸ã®ãƒœã‚¿ãƒ³ -->
    <div class="top-nav">
      <a href="contents.html">
        <button class="top-nav-btn">
          <span class="icon">ğŸ¥</span>
          <span>å‹•ç”»ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¦‹ã‚‹</span>
        </button>
      </a>
      <a href="history.html">
        <button class="top-nav-btn">
          <span class="icon">ğŸ“Š</span>
          <span>å­¦ç¿’å±¥æ­´ãƒšãƒ¼ã‚¸ã¸</span>
        </button>
      </a>
    </div>

    <div class="layout">
      <!-- å·¦ï¼šå•é¡Œï¼†å…¥åŠ› -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-title-pill" data-i18n="practice-pill">Practice</span>
            <span id="question-label">å•é¡Œ 0 / 0</span>
          </div>
          <div class="lang-toggle">
            <button id="lang-ja" class="active">æ—¥æœ¬èª</button>
            <button id="lang-en">English</button>
          </div>

          <!-- ãƒ«ãƒ“è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
          <button id="toggle-ruby" class="auth-small-btn" style="margin-left:8px;">
            ãƒ«ãƒ“è¡¨ç¤ºï¼šOFF
          </button>
          
        </div>

        <!-- å‡ºé¡Œæ¡ä»¶ -->
        <div class="filter-row">
          <span data-i18n="filter-category">ã‚«ãƒ†ã‚´ãƒª:</span>
          <select id="category-filter"></select>
          <span data-i18n="filter-count">å•é¡Œæ•°:</span>
          <select id="question-count"></select>
          <button id="btn-start-session" data-i18n="filter-start">å‡ºé¡Œé–‹å§‹</button>
        </div>

        <div class="question-meta">
          <span class="badge" id="category-label"></span>
          <span id="id-label"></span>
          <span id="random-label"></span>
        </div>

        <div class="question-text" id="question-text-ja">
          <!-- æ—¥æœ¬èªå•é¡Œæ–‡ -->
        </div>
        <div class="question-text" id="question-text-en" style="display:none;">
          <!-- English question -->
        </div>

        <div class="toggle-row">
          <span data-i18n="toggle-main">å€Ÿæ–¹ãƒ»è²¸æ–¹ã®ç§‘ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</span>
          <label>
            <input type="checkbox" id="random-mode" />
            <span data-i18n="toggle-random">ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</span>
          </label>
        </div>

        <p class="hint-text" id="hint-text" data-furigana-target>
          è¡Œã”ã¨ã«ã€Œå€Ÿæ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã€Œè²¸æ–¹å‹˜å®šç§‘ç›®ãƒ»é‡‘é¡ã€ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
          ä¸è¦ãªæ¬„ã¯ç§‘ç›®ã‚’ã€Œç©ºæ¬„ã€ã®ã¾ã¾ã€é‡‘é¡ã‚‚ç©ºæ¬„ã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
        </p>

        <!-- ä»•è¨³å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="entry-table">
          <div class="entry-header-row">
            <span data-i18n="entry-col-row">è¡Œ</span>
            <span data-i18n="entry-col-debit">å€Ÿæ–¹å‹˜å®šç§‘ç›®</span>
            <span data-i18n="entry-col-debit-amount">é‡‘é¡</span>
            <span data-i18n="entry-col-credit">è²¸æ–¹å‹˜å®šç§‘ç›®</span>
            <span data-i18n="entry-col-credit-amount">é‡‘é¡</span>
          </div>

          <!-- 4è¡Œåˆ†ç”¨æ„ -->
          <div class="entry-row">
            <span class="row-label">1</span>
            <select class="account-select" id="debit-account-1"></select>
            <input type="number" id="debit-amount-1" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-1"></select>
            <input type="number" id="credit-amount-1" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">2</span>
            <select class="account-select" id="debit-account-2"></select>
            <input type="number" id="debit-amount-2" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-2"></select>
            <input type="number" id="credit-amount-2" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">3</span>
            <select class="account-select" id="debit-account-3"></select>
            <input type="number" id="debit-amount-3" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-3"></select>
            <input type="number" id="credit-amount-3" min="0" inputmode="numeric" />
          </div>

          <div class="entry-row">
            <span class="row-label">4</span>
            <select class="account-select" id="debit-account-4"></select>
            <input type="number" id="debit-amount-4" min="0" inputmode="numeric" />
            <select class="account-select" id="credit-account-4"></select>
            <input type="number" id="credit-amount-4" min="0" inputmode="numeric" />
          </div>
        </div>

        <div class="button-row">
          <button id="prev-question" class="btn btn-secondary" data-i18n="btn-prev">â® å‰ã®å•é¡Œã¸</button>
          <button id="check-answer" class="btn btn-primary" data-i18n="btn-check">âœ” ç­”ãˆåˆã‚ã›</button>
          <button id="next-question" class="btn btn-outline" data-i18n="btn-next">â­ æ¬¡ã®å•é¡Œã¸</button>
        </div>

        <div id="result-message" class="result-message"></div>

        <div class="answer-panel" id="answer-panel" style="display:none;">
          <h3 data-i18n="answer-title">æ¨¡ç¯„ä»•è¨³ / Model Answer</h3>
          <pre id="answer-ja"></pre>
          <pre id="answer-en"></pre>
          <small data-i18n="answer-note">â€» ç§‘ç›®åã¨é‡‘é¡ãŒåˆè‡´ã—ã¦ã„ã‚Œã°æ­£è§£ã§ã™ï¼ˆè¡Œã®é †ç•ªã¯å•ã„ã¾ã›ã‚“ï¼‰ã€‚</small>
        </div>
      </section>

      <!-- å³ï¼šé€²æ—ï¼†å±¥æ­´ -->
      <aside class="card">
        <div class="side-card-title" data-i18n="progress-title">é€²æ— / Progress</div>
        <div class="score-box">
          <div class="score-pill" id="score-pill">æ­£è§£ 0 / 0</div>
        </div>
        
        <p id="progress-help"
          data-i18n="progress-help"
          style="font-size:0.8rem; color:var(--text-muted); margin-top:0;">
          ãƒ»ã€Œå‡ºé¡Œé–‹å§‹ã€ã§é¸æŠã—ãŸæ¡ä»¶ã®å•é¡Œã‚»ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚<br>
          ãƒ»ã€Œç­”ãˆåˆã‚ã›ã€ã§è‡ªå‹•åˆ¤å®šã—ã¾ã™ã€‚<br>
          ãƒ»ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã‚’ONã«ã™ã‚‹ã¨ã€é †ç•ªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚<br>
          ãƒ»æ—¥æœ¬èª / è‹±èªã¯ã„ã¤ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã§ã™ã€‚
        </p>

        <div class="history-box-title" data-i18n="history-title">ç›´è¿‘ã®å­¦ç¿’å±¥æ­´</div>
        <div id="history-list" class="history-list">
          <!-- å±¥æ­´ãŒå…¥ã‚‹ -->
        </div>
      </aside>
    </div>

    <footer>
      &copy; Liberty Co., Ltd. Bookkeeping Trainer 2.0
    </footer>
  </div>
</body>
</html>


