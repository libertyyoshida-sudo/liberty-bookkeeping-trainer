<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‹˜å®šç§‘ç›®ã‚¯ã‚¤ã‚º</title>
  
  <!-- âœ… å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã¨è¨­å®šã‚’èª­ã¿è¾¼ã‚€ -->
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* quiz.html å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .page { max-width: 800px; }
    
    .quiz-options {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-soft);
    }
    
    .quiz-options label {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .choice-btn {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      background: #fff;
      font-size: 0.95rem;
      line-height: 1.25;  
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-main);
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .choice-btn:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .grid { display: grid; gap: 12px; margin-top: 20px; }
    
    .result-area {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      display: none; /* åˆæœŸéè¡¨ç¤º */
    }
    .result-area.ok { background: #d4edda; color: #155724; display: block; }
    .result-area.ng { background: #f8d7da; color: #721c24; display: block; }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
    .loading-container {
      text-align: center;
      padding: 40px 0;
      display: none;
    }
    .spinner {
      width: 40px; height: 40px; margin: 0 auto 16px;
      border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ */
    .timer-bar-bg {
      height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 10px; display: none;
    }
    .timer-bar-fill {
      height: 100%; background: #28a745; width: 100%; transition: width 0.1s linear, background-color 0.3s;
    }

    /* ã‚¹ãƒãƒ›ç”»é¢ã»ã‚“ã®å°‘ã—å°ã•ã */
    @media (max-width: 480px) {
  .choice-btn {
    padding: 10px 12px;      /* 16px â†’ 10px */
    font-size: 0.95rem;      /* ã»ã‚“ã®å°‘ã—å°ã•ã */
    line-height: 1.25;       /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
  }
  .grid { gap: 8px; margin-top: 12px; }
  .result-area { margin-top: 12px; padding: 12px; font-size: 1.05rem; }
}

    
  </style>
</head>
<body>
  <div class="page">
    <header>
      <img src="https://liberty-system.co.jp/common/img/logo.png" alt="Liberty" class="logo" />
      <h1 style="font-size:1.4rem; color:var(--primary); margin:0;">å‹˜å®šç§‘ç›®ã‚¯ã‚¤ã‚º</h1>
    </header>

    <div class="nav-links" style="margin-bottom:16px;">
      <a href="index.html" class="back-link">â† ãƒˆãƒƒãƒ—ï¼ˆå•é¡Œï¼‰ã¸æˆ»ã‚‹</a>
    </div>

    <div class="card">
      <div class="quiz-options">
        <label>Language:
          <select id="lang">
            <option value="ja" selected>æ—¥æœ¬èª</option>
            <option value="en">English</option>
          </select>
        </label>
        <button id="sound-toggle-btn" class="btn" style="padding: 6px 10px;">ğŸ”Š</button>

        <label>Mode:
          <select id="mode">
            <option value="statement" selected>ã‚„ã•ã—ã„ï¼ˆBS/PLã§é¸æŠè‚¢ï¼‰</option>
            <option value="category">ã‚€ãšã‹ã—ã„ï¼ˆã‚«ãƒ†ã‚´ãƒªå„ªå…ˆï¼‰</option>
          </select>
        </label>

        <label style="margin-left:8px; cursor:pointer;">
          <input type="checkbox" id="time-attack" /> â± 10s Challenge
        </label>

        <div id="streak-box" style="margin-left:16px; font-weight:bold; color:#e67e22; display:none; align-items:center; gap:4px;">
          ğŸ”¥ <span id="streak-count">0</span> Streak!
        </div>

        <label>å•é¡Œæ•°:
          <select id="quiz-count">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="9999">ç„¡åˆ¶é™</option>
          </select>
        </label>

        <div id="quiz-progress" style="font-weight:bold; color:#555;">
          0 / 10
        </div>

        
        <button class="btn btn-primary" id="nextBtn" style="margin-left:auto;">æ¬¡ã®å•é¡Œ</button>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div id="loading-container" class="loading-container">
        <div class="spinner"></div>
        <div style="color:var(--text-muted); font-size:0.9rem;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>

      <div id="timer-container" class="timer-bar-bg">
        <div id="timer-bar" class="timer-bar-fill"></div>
      </div>

      <div class="question-text" id="prompt" style="font-size:1.1rem; font-weight:bold; min-height:auto; display:none;"></div>

      <div class="grid" id="choices"></div>

      <div class="result-area" id="result"></div>
      
      <!-- è§£èª¬ã‚¨ãƒªã‚¢ -->
      <div id="explain-area" style="display:none; margin-top:20px; padding:16px; background:#f8f9fa; border-radius:12px; border:1px solid #e9ecef;">
        <div id="correct-display" style="font-weight:bold; color:#d9534f; margin-bottom:12px;"></div>
        <button id="btn-ai-explain" class="btn btn-secondary" style="width:100%;">ğŸ¤– ãªãœï¼Ÿ (AIè§£èª¬)</button>
        <div id="ai-explanation" style="margin-top:12px; font-size:0.9rem; line-height:1.6; color:#333; display:none; white-space: pre-wrap;"></div>
      </div>

      <div id="debug" style="font-size:0.75rem; color:#ccc; margin-top:10px; text-align:right;"></div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // config.js ã®å€¤ã‚’åˆ©ç”¨
      const supabaseUrl = window.SUPABASE_URL;
      const supabaseKey = window.SUPABASE_ANON_KEY;
      const { createClient } = window.supabase;
      const supabaseClient = createClient(supabaseUrl, supabaseKey);

      const promptEl = document.getElementById("prompt");
      const choicesEl = document.getElementById("choices");
      const resultEl = document.getElementById("result");
      const debugEl = document.getElementById("debug");
      const langEl = document.getElementById("lang");
      const modeEl = document.getElementById("mode");
      const nextBtn = document.getElementById("nextBtn");
      const streakBox = document.getElementById("streak-box");
      const streakCountEl = document.getElementById("streak-count");
      const explainArea = document.getElementById("explain-area");
      const correctDisplay = document.getElementById("correct-display");
      const btnAiExplain = document.getElementById("btn-ai-explain");
      const aiExplanation = document.getElementById("ai-explanation");
      const loadingContainer = document.getElementById("loading-container");
      const timeAttackCheck = document.getElementById("time-attack");
      const timerContainer = document.getElementById("timer-container");
      const timerBar = document.getElementById("timer-bar");
      const countEl = document.getElementById("quiz-count");ã€€// â˜…è¿½åŠ ï¼šå•é¡Œæ•°UI
      const progressEl = document.getElementById("quiz-progress");

      // â˜…è¿½åŠ ï¼šå‡ºé¡Œæ•°ç®¡ç†
      let quizLimit = Number(countEl?.value ?? 10); // selectã®åˆæœŸå€¤
      let quizCurrentNo = 0;

ã€€ã€€ã€€// â˜…è¿½åŠ ï¼šå•é¡Œæ•°å¤‰æ›´æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
      function resetQuizCounter() {
        quizLimit = Number(countEl.value);
        quizCurrentNo = 0;
        progressEl.textContent = `0 / ${quizLimit === 9999 ? "âˆ" : quizLimit}`;
        nextBtn.disabled = false;
      }
      countEl.addEventListener("change", resetQuizCounter);
      resetQuizCounter();
      
      let current = null;
      let currentUser = null;
      let streak = 0;
      let timerInterval = null;
      const TIME_LIMIT = 10; // ç§’


      
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
      supabaseClient.auth.getUser().then(({ data }) => {
        currentUser = data?.user;
      });

      async function loadQuiz(){
        // â˜…è¿½åŠ ï¼šå•é¡Œæ•°ã«é”ã—ãŸã‚‰çµ‚äº†
        if (quizLimit !== 9999 && quizCurrentNo >= quizLimit) {
          promptEl.textContent = "âœ… ã“ã“ã¾ã§ï¼ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
          choicesEl.innerHTML = "";
          resultEl.className = "result-area ok";
          resultEl.textContent = "è¨­å®šã—ãŸå•é¡Œæ•°ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚";
          nextBtn.disabled = true;
          return;
        }

        resultEl.textContent = "";
        choicesEl.innerHTML = "";
        stopTimer(); // å‰ã®ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºé–‹å§‹
        loadingContainer.style.display = "block";
        promptEl.style.display = "none";
        choicesEl.style.display = "none";

        explainArea.style.display = "none";
        aiExplanation.style.display = "none";
        aiExplanation.textContent = "";
        btnAiExplain.disabled = false;
        btnAiExplain.textContent = "ğŸ¤– ãªãœï¼Ÿ (AIè§£èª¬)";

        const { data: rawData, error } = await supabaseClient.rpc("get_accounts_quiz", {
          lang: langEl.value,
          mode: modeEl.value
        });

        // â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆæ®‹ã—ã¦ãŠãã¾ã™ï¼‰ â˜…â˜…â˜…
        console.log("Supabase RPC 'get_accounts_quiz' response:", { data: rawData, error });
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
        loadingContainer.style.display = "none";
        promptEl.style.display = "block";
        choicesEl.style.display = "grid";

        if(error){
          promptEl.textContent = "ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸã€‚";
          debugEl.textContent = error.message;
          return;
        }

        // RPCãŒé…åˆ—ã‚’è¿”ã™å ´åˆã«å¯¾å¿œ
        const data = (Array.isArray(rawData) && rawData.length > 0) ? rawData[0] : rawData;

        // Add robust check for data and data.choices
        if (!data || !Array.isArray(data.choices)) {
          // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›
          if (data && typeof data === 'object' && !Array.isArray(data)) {
            console.error("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼:", Object.keys(data));
          } else {
            console.error("ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿:", data);
          }
          
          promptEl.textContent = "ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
          debugEl.textContent = "RPC 'get_accounts_quiz' did not return a valid quiz object. Check the function's return value in Supabase.";
          return;
        }

        current = data;
        // â˜…è¿½åŠ ï¼šé€²æ—ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        quizCurrentNo++;
        progressEl.textContent = `${quizCurrentNo} / ${quizLimit === 9999 ? "âˆ" : quizLimit}`;

        promptEl.textContent = data.prompt;

        function shuffleArray(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }

        // choices ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
         const shuffledChoices = shuffleArray([...data.choices]);

         shuffledChoices.forEach(c => {
           const btn = document.createElement("button");
           btn.className = "choice-btn";
           btn.textContent = c.label;
           btn.onclick = () => answer(c.id);
           choicesEl.appendChild(btn);
         });
                
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆé‹ç”¨æ™‚ã¯æ¶ˆã—ã¦ãã ã•ã„ï¼‰
        debugEl.textContent = `question_id=${data.question_id} / correct=${data.correct_account_code}`;

        // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
        startTimer();
      }

      // Web Audio API ã§ç°¡æ˜“SEå†ç”Ÿ
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playTone(isCorrect) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªãƒ–ãƒ©ã‚¦ã‚¶å¯¾ç­–ã§resume
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (isCorrect) {
          // æ­£è§£ï¼šãƒ”ãƒ³ãƒãƒ³ï¼ˆã‚µã‚¤ãƒ³æ³¢ã§2éŸ³ï¼‰
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, now); 
          osc.frequency.setValueAtTime(1100, now + 0.15); 
          
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.linearRampToValueAtTime(0.1, now + 0.3);
          gain.gain.linearRampToValueAtTime(0.001, now + 0.6);
          
          osc.start(now);
          osc.stop(now + 0.6);
        } else {
          // ä¸æ­£è§£ï¼šãƒ–ãƒ–ãƒ¼ï¼ˆãƒã‚³ã‚®ãƒªæ³¢ã§ä½éŸ³ï¼‰
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(150, now);
          osc.frequency.linearRampToValueAtTime(100, now + 0.3);

          gain.gain.setValueAtTime(0.1, now);
          gain.gain.linearRampToValueAtTime(0.001, now + 0.4);

          osc.start(now);
          osc.stop(now + 0.4);
        }
      }

      // å­¦ç¿’ãƒ­ã‚°ä¿å­˜
      async function saveLog(isCorrect) {
        if (!currentUser || !current) return;

        const { error } = await supabaseClient.from('study_logs').insert({
          user_id: currentUser.id,
          content_type: 'account_quiz', // ä»•è¨³å•é¡Œ(quiz)ã¨åŒºåˆ¥
          content_id: String(current.question_id),
          is_correct: isCorrect,
          created_at: new Date().toISOString(),
          meta: {
            mode: modeEl.value,
            lang: langEl.value
          }
        });

        if (error) {
          console.error('Log save error:', error);
        }
      }

      // AIè§£èª¬ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      async function askAi() {
        if (!current) return;
        const WORKER_URL = window.APP_AI_WORKER_URL;
        if (!WORKER_URL) {
          alert("AI Worker URL not configured.");
          return;
        }

        btnAiExplain.disabled = true;
        btnAiExplain.textContent = "è§£èª¬ã‚’ç”Ÿæˆä¸­...";
        aiExplanation.style.display = "block";
        aiExplanation.textContent = "è€ƒãˆä¸­...";

        const correctChoice = current.choices.find(c => String(c.id) === String(current.correct_account_id));
        const correctLabel = correctChoice ? correctChoice.label : "Unknown";

        const prompt = `
ã‚ãªãŸã¯ç°¿è¨˜ã®å…ˆç”Ÿã§ã™ã€‚ä»¥ä¸‹ã®å‹˜å®šç§‘ç›®ã‚¯ã‚¤ã‚ºã®è§£èª¬ã‚’ã—ã¦ãã ã•ã„ã€‚

ã€å•é¡Œã€‘${current.prompt}
ã€æ­£è§£ã€‘${correctLabel}

ãªãœã“ã®ç§‘ç›®ãŒæ­£è§£ãªã®ã‹ã€åˆå¿ƒè€…ã«ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«çŸ­ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚
`.trim();

        try {
          const res = await fetch(WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: prompt }),
          });

          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();
          const answer = data.answer || data.response || JSON.stringify(data);
          
          aiExplanation.textContent = answer;
        } catch (e) {
          console.error(e);
          aiExplanation.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message;
        } finally {
          btnAiExplain.textContent = "ğŸ¤– è§£èª¬ã‚’å†ç”Ÿæˆ";
          btnAiExplain.disabled = false;
        }
      }

      btnAiExplain.addEventListener("click", askAi);

      // --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ---
      function startTimer() {
        if (!timeAttackCheck.checked) {
          timerContainer.style.display = "none";
          return;
        }
        timerContainer.style.display = "block";
        timerBar.style.width = "100%";
        timerBar.style.backgroundColor = "#28a745";

        const startTime = Date.now();
        const limitMs = TIME_LIMIT * 1000;

        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const remain = limitMs - elapsed;
          
          if (remain <= 0) {
            stopTimer();
            handleTimeUp();
            return;
          }

          const pct = (remain / limitMs) * 100;
          timerBar.style.width = `${pct}%`;

          // è‰²å¤‰åŒ–
          if (pct < 30) timerBar.style.backgroundColor = "#d9534f"; // èµ¤
          else if (pct < 60) timerBar.style.backgroundColor = "#ffc107"; // é»„
        }, 100);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function handleTimeUp() {
        answer(null, true); // nullID, isTimeUp=true
      }

      function answer(selectedId, isTimeUp = false){
        stopTimer(); // å›ç­”ã—ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼åœæ­¢

        // é¸æŠãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–
        const btns = document.querySelectorAll(".choice-btn");
        btns.forEach(b => b.disabled = true);

        const ok = String(selectedId) === String(current.correct_account_id);
        
        // éŸ³ã‚’é³´ã‚‰ã™
        playTone(ok && !isTimeUp);
        // ãƒ­ã‚°ä¿å­˜
        saveLog(ok && !isTimeUp);

        // ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°
        if (ok && !isTimeUp) {
          streak++;
          streakBox.style.display = "inline-flex";
          streakCountEl.textContent = streak;

          // 5å›é€£ç¶šæ­£è§£ã”ã¨ã«ç´™å¹é›ªã§ãŠç¥ã„
          if (streak > 0 && streak % 5 === 0) {
            confetti({
              particleCount: 150,
              spread: 70,
              origin: { y: 0.6 }
            });
          }
        } else {
          streak = 0;
          streakBox.style.display = "none";
        }

        if (isTimeUp) {
          resultEl.className = "result-area ng";
          resultEl.textContent = "â° æ™‚é–“åˆ‡ã‚Œï¼";
        } else {
          resultEl.className = "result-area " + (ok ? "ok" : "ng");
          resultEl.textContent = ok ? "âœ… æ­£è§£ï¼" : "âŒ ã¡ãŒã„ã¾ã™";
        }

        // è§£èª¬ã‚¨ãƒªã‚¢è¡¨ç¤º
        explainArea.style.display = "block";
        if (!ok || isTimeUp) {
          const correctChoice = current.choices.find(c => String(c.id) === String(current.correct_account_id));
          correctDisplay.style.display = "block";
          correctDisplay.textContent = `æ­£è§£ã¯: ${correctChoice ? correctChoice.label : '???'}`;
        } else {
          correctDisplay.style.display = "none";
        }
      }

      nextBtn.addEventListener("click", loadQuiz);
      loadQuiz();
    });
  </script>
</body>
</html>
